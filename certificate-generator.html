<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator - LTO Blockchain</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/auth-manager.js"></script>
    <script src="js/auth-utils.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/toast-notification.js"></script>
    <script src="js/mobile-nav.js"></script>
    <style>
        /* Form Specific Styles */
        .form-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .form-tab:hover {
            color: #0284c7;
        }

        .form-tab.active {
            color: #0284c7;
            border-bottom-color: #0284c7;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .form-section h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #475569;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        /* Badges */
        .info-badge {
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Certificate Status Styles */
        .certificate-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 4px solid #e2e8f0;
            border: 1px solid #e2e8f0;
            border-left-width: 4px;
        }

        .certificate-item.success {
            border-left-color: #22c55e;
        }

        .certificate-item.error {
            border-left-color: #ef4444;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0284c7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <img src="assets/lto-logo.png" alt="LTO Logo"
                        onerror="this.src='https://via.placeholder.com/40?text=LTO'">
                </div>
                <div class="logo-text">
                    <span class="logo-title">LTO Portal</span>
                    <span class="logo-subtitle">Admin System</span>
                </div>
                <button id="sidebarToggle" class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="admin-dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="admin-dashboard.html#vehicles" class="nav-item">
                    <i class="fas fa-car"></i>
                    <span>Vehicles</span>
                </a>
                <a href="admin-dashboard.html#applications" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Applications</span>
                </a>
                <a href="certificate-generator.html" class="nav-item active">
                    <i class="fas fa-certificate"></i>
                    <span>Certificate Gen</span>
                </a>
                <a href="transfer-certificate-generator.html" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transfer Gen</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user-profile">
                    <div class="sidebar-user-avatar">AD</div>
                    <div class="sidebar-user-details">
                        <span class="sidebar-user-name">ADMIN</span>
                        <span class="sidebar-user-role">Administrator</span>
                    </div>
                </div>
                <div class="sidebar-user-actions">
                    <a href="#" class="sidebar-action-item" onclick="AuthUtils.logout(); return false;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <header class="dashboard-header">
                <div class="container">
                    <div class="dashboard-nav">
                        <div class="logo">
                            <h1>LTO MANAGEMENT SYSTEM</h1>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="container">
                    <!-- Welcome Section -->
                    <div class="welcome-section-admin" style="margin-bottom: 2rem;">
                        <div class="welcome-content">
                            <h1 class="welcome-title">Certificate Generator</h1>
                            <p class="welcome-subtitle">Generate Insurance, Emission, HPG, and CSR certificates in one
                                go</p>
                        </div>
                    </div>

                    <!-- Generator Interface -->
                    <div class="dashboard-card-modern">

                        <div class="form-tabs">
                            <button class="form-tab active" onclick="switchTab('auto')">Auto-Fill Mode</button>
                            <button class="form-tab" onclick="switchTab('manual')">Manual Mode</button>
                        </div>

                        <!-- Auto Mode Form -->
                        <div id="autoForm" class="form-container active">
                            <div class="info-badge success"
                                style="background: #e0f2fe; color: #0284c7; border-left-color: #0284c7;">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>How it works:</strong> Enter an owner's email address. The system will
                                    auto-generate all required certificates using mock data compatible with the owner's
                                    profile.
                                </div>
                            </div>

                            <form onsubmit="handleGenerate(event, 'auto')">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Owner Email <span style="color:red">*</span></label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="email" id="ownerEmail" name="ownerEmail" class="form-control"
                                                placeholder="Enter owner's registered email" required>
                                            <button type="button" class="btn-primary"
                                                onclick="verifyOwner('ownerEmail')"
                                                style="padding: 0 1.5rem;">Verify</button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Vehicle Type</label>
                                        <select name="vehicleType" class="form-control">
                                            <option value="Car">Car</option>
                                            <option value="SUV">SUV</option>
                                            <option value="Motorcycle">Motorcycle</option>
                                            <option value="Truck">Truck</option>
                                            <option value="Van">Van</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="autoOwnerPreview" class="info-badge"
                                    style="display: none; background: #f0fdf4; color: #15803d; border-left-color: #22c55e;">
                                    <i class="fas fa-check-circle"></i>
                                    <div>
                                        <strong>Owner Verified:</strong> <span id="autoOwnerName"></span>
                                    </div>
                                </div>

                                <button type="submit" class="btn-primary"
                                    style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                                    <i class="fas fa-magic"></i> Generate All Certificates
                                </button>
                            </form>
                        </div>

                        <!-- Manual Mode Form -->
                        <div id="manualForm" class="form-container">
                            <form onsubmit="handleGenerate(event, 'manual')">
                                <div class="form-section">
                                    <h4>Owner Information</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Owner Email <span style="color:red">*</span></label>
                                            <div style="display: flex; gap: 10px;">
                                                <input type="email" id="manualOwnerEmail" name="ownerEmail"
                                                    class="form-control" required>
                                                <button type="button" class="btn-primary"
                                                    onclick="verifyOwner('manualOwnerEmail')">Verify</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="manualOwnerPreview" class="info-badge"
                                        style="display: none; background: #f0fdf4; color: #15803d; border-left-color: #22c55e;">
                                        <i class="fas fa-check-circle"></i>
                                        <div>
                                            <strong>Owner Verified:</strong> <span id="manualOwnerName"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4>Vehicle Details</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>VIN <span style="color:red">*</span></label>
                                            <input type="text" name="vin" class="form-control" required
                                                placeholder="17-digit VIN">
                                        </div>
                                        <div class="form-group">
                                            <label>Plate Number <span style="color:red">*</span></label>
                                            <input type="text" name="plate" class="form-control" required
                                                placeholder="ABC-1234">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Make</label>
                                            <input type="text" name="vehicleMake" class="form-control"
                                                placeholder="e.g. Toyota">
                                        </div>
                                        <div class="form-group">
                                            <label>Model</label>
                                            <input type="text" name="vehicleModel" class="form-control"
                                                placeholder="e.g. Vios">
                                        </div>
                                        <div class="form-group">
                                            <label>Year</label>
                                            <input type="number" name="vehicleYear" class="form-control"
                                                placeholder="2024">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn-primary"
                                    style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                                    <i class="fas fa-cog"></i> Generate Certificates Manually
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="certificateStatus" class="dashboard-card-modern" style="display: none;">
                        <!-- Results injected here -->
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner" style="margin: 0 auto 1rem;"></div>
            <h3>Generating Certificates...</h3>
            <p>Interacting with blockchain and generating PDFs</p>
        </div>
    </div>

    <script>
        // Init Mobile Nav
        if (typeof MobileNav !== 'undefined') {
            MobileNav.init();
        }

        function switchTab(tab) {
            document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(c => c.classList.remove('active'));

            // Activate selected
            const tabBtn = document.querySelector(`.form-tab[onclick="switchTab('${tab}')"]`);
            if (tabBtn) tabBtn.classList.add('active');

            document.getElementById(tab + 'Form').classList.add('active');
        }

        async function verifyOwner(inputId) {
            const emailInput = document.getElementById(inputId);
            if (!emailInput || !emailInput.value) {
                if (typeof ToastNotification !== 'undefined') {
                    ToastNotification.show('Please enter an email address', 'error');
                } else {
                    alert('Please enter an email address');
                }
                return;
            }

            const email = emailInput.value.trim();
            const previewId = inputId === 'ownerEmail' ? 'autoOwnerPreview' : 'manualOwnerPreview';
            const nameId = inputId === 'ownerEmail' ? 'autoOwnerName' : 'manualOwnerName';
            const previewEl = document.getElementById(previewId);
            const nameEl = document.getElementById(nameId);

            try {
                // Mock verification or use API if available
                // Ideally this calls /api/users?email=...
                // For now, we'll simulate success if email looks valid
                if (email.includes('@')) {
                    previewEl.style.display = 'flex';
                    nameEl.textContent = 'Verified User'; // Placeholder
                    if (typeof ToastNotification !== 'undefined') {
                        ToastNotification.show('User verified successfully', 'success');
                    }
                } else {
                    throw new Error('Invalid email format');
                }
            } catch (error) {
                previewEl.style.display = 'none';
                if (typeof ToastNotification !== 'undefined') {
                    ToastNotification.show('User not found', 'error');
                } else {
                    alert('User not found');
                }
            }
        }

        async function handleGenerate(event, formType) {
            event.preventDefault();
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('show');
            const statusDiv = document.getElementById('certificateStatus');
            statusDiv.style.display = 'none';

            try {
                const form = event.target;
                const formData = {
                    type: formType,
                    ownerEmail: form.ownerEmail.value.trim()
                };

                if (formType === 'manual') {
                    Object.assign(formData, {
                        vin: form.vin.value.trim(),
                        plate: form.plate.value.trim(),
                        vehicleMake: form.vehicleMake.value.trim() || undefined,
                        vehicleModel: form.vehicleModel.value.trim() || undefined,
                        vehicleYear: form.vehicleYear.value ? parseInt(form.vehicleYear.value) : undefined,
                    });
                } else {
                    formData.vehicleType = form.vehicleType.value;
                }

                // Call API
                const apiClient = window.apiClient || new APIClient();
                // Note: Ensure /api/certificate-generation/batch/generate-all exists or mock it

                // Call API
                const apiClient = window.apiClient || new APIClient();
                const response = await apiClient.post('/api/certificate-generation/batch/generate-all', formData);

                // Check for success
                if (!response.success) {
                    throw new Error(response.error || 'Generation failed');
                }

                loadingOverlay.classList.remove('show');
                displayResults(response, formData);

            } catch (error) {
                console.error('Error:', error);
                loadingOverlay.classList.remove('show');
                if (typeof ToastNotification !== 'undefined') {
                    ToastNotification.show(error.message || 'Generation failed', 'error');
                }
            }
        }

        function displayResults(response, formData) {
            const statusDiv = document.getElementById('certificateStatus');
            statusDiv.style.display = 'block';

            if (!response.success) {
                statusDiv.innerHTML = `<div class="info-badge error">Generation Failed</div>`;
                return;
            }

            const certs = response.certificates;
            const veh = response.vehicleData;

            let html = `
                <h3 style="margin-top:0; color:#1e293b;">Generation Complete</h3>
                <div class="info-badge success" style="background: #ecfccb; color: #3f6212; border-left-color: #65a30d;">
                     <i class="fas fa-check-circle"></i> Result: Success
                </div>
                
                <div class="form-section">
                    <h4>Vehicle Summary</h4>
                    <p><strong>VIN:</strong> ${veh.vin} | <strong>Plate:</strong> ${veh.plate}</p>
                </div>

                <div class="form-row">
            `;

            const items = [
                { name: 'Insurance', icon: 'shield-alt', data: certs.insurance, num: certs.insurance?.certificateNumber },
                { name: 'Emission', icon: 'leaf', data: certs.emission, num: certs.emission?.certificateNumber },
                { name: 'HPG', icon: 'id-badge', data: certs.hpg, num: certs.hpg?.clearanceNumber },
                { name: 'CSR', icon: 'file-contract', data: certs.csr, num: certs.csr?.csrNumber }
            ];

            items.forEach(item => {
                if (item.data) {
                    html += `
                        <div class="certificate-item success">
                            <h5 style="margin:0 0 0.5rem 0"><i class="fas fa-${item.icon}"></i> ${item.name}</h5>
                            <small>${item.num}</small>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="certificate-item error">
                            <h5 style="margin:0 0 0.5rem 0"><i class="fas fa-${item.icon}"></i> ${item.name}</h5>
                            <small>Failed</small>
                        </div>
                    `;
                }
            });

            html += `</div>`;
            statusDiv.innerHTML = html;

            // Scroll to results
            statusDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>

</html>