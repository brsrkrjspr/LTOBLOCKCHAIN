<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer of Ownership - LTO Management System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           OWNER DASHBOARD SIDEBAR TOGGLE & HEADER IMPROVEMENTS
           ============================================ */
        
        /* Smooth Sidebar Transitions */
        .dashboard-sidebar {
            transition: width 0.3s ease-in-out;
        }
        
        .dashboard-main {
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Logo Toggle Styling */
        .dashboard-sidebar .logo#logoToggle {
            transition: opacity 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }
        
        .dashboard-sidebar .logo#logoToggle:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        .dashboard-sidebar .logo#logoToggle:active {
            transform: scale(0.95);
        }
        
        .dashboard-sidebar .logo#logoToggle:focus {
            outline: 2px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        .dashboard-sidebar .logo-image {
            transition: transform 0.2s ease;
            max-width: 80px !important;
            width: 80px !important;
            height: auto !important;
            display: block !important;
            margin: 0 auto !important;
        }
        
        .dashboard-sidebar .logo#logoToggle:hover .logo-image {
            transform: scale(1.05);
        }
        
        /* Center logo at top of sidebar and remove extra spacing */
        .dashboard-sidebar .sidebar-header {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 0.75rem 0 !important;
            margin: 0 !important;
        }
        
        .dashboard-sidebar .logo#logoToggle {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 0 auto !important;
            padding: 0 !important;
        }
        
        /* Header Improvements */
        .dashboard-header .container {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        .dashboard-header .dashboard-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dashboard-header .nav-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .dashboard-header .logo {
            display: flex;
            align-items: center;
        }
        
        .dashboard-header .logo h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900, #111827);
            line-height: 1.2;
        }
        
        .dashboard-header .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* ============================================
           COMPREHENSIVE UI/UX IMPROVEMENTS
           ============================================ */
        
        /* 1. TEXT PLACEMENT & READABILITY */
        /* Typography Hierarchy */
        .dashboard-content h1,
        .dashboard-content .page-title {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
            margin: 0 0 0.5rem 0;
            color: #111827;
        }
        
        .dashboard-content h2,
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.3;
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }
        
        .dashboard-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.4;
            margin: 0 0 0.75rem 0;
            color: #374151;
        }
        
        .section-subtitle,
        .dashboard-content p.subtitle {
            font-size: 0.9375rem;
            font-weight: 400;
            line-height: 1.5;
            color: #6b7280;
            margin: 0 0 1.5rem 0;
        }
        
        .section-header {
            margin-bottom: 1.5rem;
        }
        
        .section-header h2 {
            margin-bottom: 0.25rem;
        }
        
        /* Form Labels */
        .form-group label,
        label {
            font-size: 0.9375rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
            line-height: 1.5;
        }
        
        /* Helper Text */
        .hint,
        small.hint,
        .form-group small {
            font-size: 0.8125rem;
            color: #6b7280;
            margin-top: 0.25rem;
            display: block;
            line-height: 1.4;
        }
        
        /* 2. BUTTON CONSISTENCY */
        /* Unified Button System */
        button,
        .btn,
        .btn-primary,
        .btn-secondary,
        .btn-success,
        .btn-danger,
        .btn-warning,
        .btn-info,
        .btn-sm,
        .btn-lg,
        .btn-card-primary,
        .btn-card-secondary,
        .btn-card-success,
        .btn-card-transfer,
        a.btn,
        a.btn-primary,
        a.btn-secondary {
            /* Base Properties */
            height: 44px;
            min-height: 44px;
            padding: 0.75rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 600;
            line-height: 1.5;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
            text-decoration: none;
            white-space: nowrap;
        }
        
        /* Small Buttons */
        .btn-sm {
            height: 36px;
            min-height: 36px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Large Buttons */
        .btn-lg {
            height: 52px;
            min-height: 52px;
            padding: 1rem 2rem;
            font-size: 1.0625rem;
        }
        
        /* Icon Buttons - Square */
        button.icon-btn,
        .btn-icon {
            width: 44px;
            min-width: 44px;
            height: 44px;
            min-height: 44px;
            padding: 0;
        }
        
        /* Button Alignment */
        .btn-group,
        .button-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn-group .btn,
        .button-group button {
            flex: 0 0 auto;
        }
        
        /* Button Hover States */
        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-success:hover,
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary:active,
        .btn-secondary:active,
        .btn-success:active,
        .btn-danger:active {
            transform: translateY(0);
        }
        
        /* 3. LAYOUT & SPACING */
        /* Unified Spacing System (8px base) */
        .dashboard-content {
            padding: 1.5rem;
        }
        
        .dashboard-card-modern,
        .card,
        .dashboard-card {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        /* Prevent Edge Touching */
        .dashboard-content .container {
            max-width: 100%;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        /* 4. RESPONSIVE DESIGN */
        /* Mobile (≤ 768px) */
        @media (max-width: 768px) {
            /* Typography */
            .dashboard-content h1,
            .dashboard-content .page-title {
                font-size: 1.5rem;
            }
            
            .dashboard-content h2,
            .section-title {
                font-size: 1.25rem;
            }
            
            .dashboard-content h3 {
                font-size: 1.125rem;
            }
            
            /* Buttons - Full Width */
            button,
            .btn,
            .btn-primary,
            .btn-secondary,
            .btn-success,
            .btn-danger {
                width: 100%;
                margin-bottom: 0.75rem;
            }
            
            .btn-group,
            .button-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn:last-child,
            .button-group button:last-child {
                margin-bottom: 0;
            }
            
            /* Layout - Stack Vertically */
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-content {
                padding: 1rem;
            }
            
            .dashboard-card-modern,
            .card,
            .dashboard-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .section-header {
                margin-bottom: 1rem;
            }
            
            /* Prevent Text Overflow */
            .dashboard-content {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Upload Items - Stack Vertically on Mobile */
            .transfer-upload-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .transfer-upload-info {
                width: 100%;
            }
            
            .transfer-upload-area {
                width: 100%;
                min-width: 100%;
            }
            
            .transfer-upload-label {
                width: 100%;
            }
        }
        
        /* Collapsed Sidebar - Responsive Adjustments */
        @media (min-width: 769px) {
            .dashboard-sidebar.collapsed {
                padding: 1.25rem 0.75rem;
            }
            
            .dashboard-sidebar.collapsed .sidebar-nav .nav-item {
                padding: 0.85rem 0.5rem;
            }
            
            .dashboard-sidebar.collapsed .sidebar-nav .nav-item i {
                width: 36px;
                height: 36px;
            }
        }
        
        @media (min-width: 1025px) {
            .dashboard-sidebar.collapsed {
                padding: 1.25rem 0.875rem;
            }
            
            .dashboard-sidebar.collapsed .sidebar-nav .nav-item {
                padding: 0.9rem 0.625rem;
            }
        }
        
        /* Tablet (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .form-row {
                gap: 1rem;
            }
            
            .btn-group,
            .button-group {
                flex-wrap: wrap;
            }
        }
        
        /* Desktop (≥ 1025px) */
        @media (min-width: 1025px) {
            .dashboard-content .container {
                max-width: 1400px;
                margin: 0 auto;
            }
            
            /* Grid Layouts */
            .grid-2 {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
            
            .grid-3 {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
        }
        
        /* 5. VISUAL CLEANLINESS */
        /* Improved Contrast */
        .dashboard-content {
            color: #1f2937;
            line-height: 1.6;
        }
        
        /* Input Focus States */
        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-color: #3b82f6;
        }
        
        /* Card Hover States */
        .dashboard-card-modern:hover,
        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transition: box-shadow 0.2s ease;
        }
        
        /* Table Improvements */
        .table-modern,
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-modern th,
        table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .table-modern td,
        table td {
            padding: 1rem;
            font-size: 0.9375rem;
            color: #1f2937;
            border-bottom: 1px solid #f3f4f6;
        }
        
        /* Alignment Helpers */
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .flex { display: flex; }
        .flex-column { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        
        /* Transfer Upload Section - Using same structure as registration-wizard.html */
        .transfer-upload-section {
            margin-bottom: 2rem;
        }
        .transfer-upload-section h3 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .transfer-upload-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
            background: #fff;
        }
        .transfer-upload-item:hover {
            border-color: #3498db;
        }
        .transfer-upload-item.uploaded {
            border-color: #27ae60;
            background: #f0fff4;
        }
        .transfer-upload-info h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        .transfer-upload-info p {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 0;
        }
        .transfer-upload-area {
            position: relative;
            min-width: 150px;
        }
        .transfer-upload-area input[type="file"] {
            display: none;
        }
        .transfer-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .transfer-upload-label:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }
        .transfer-upload-label.uploaded {
            border-color: #27ae60;
            border-style: solid;
            background: #d4edda;
        }
        .transfer-upload-icon {
            font-size: 1.5rem;
        }
        .transfer-upload-text {
            font-size: 0.9rem;
            color: #555;
        }
        .transfer-file-name {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #27ae60;
            font-weight: bold;
        }
        
        /* OR/CR Number readonly styling */
        #toOrNumber[readonly], #toCrNumber[readonly] {
            background-color: #f0f8ff;
            border-color: #3498db;
            cursor: not-allowed;
        }
        
        #toOrNumber[readonly]:focus, #toCrNumber[readonly]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* OR/CR info badge */
        .orcr-info-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            font-size: 0.75rem;
            background: #d4edda;
            color: #155724;
            border-radius: 12px;
            font-weight: normal;
        }
        
        .orcr-info-badge i {
            margin-right: 4px;
        }

        /* ============================================
           NAVY BLUE & WHITE GRADIENT THEME
           ============================================ */
        :root {
            --navy-primary: #001f3f;
            --navy-dark: #001529;
            --navy-light: #003d7a;
            --navy-gradient: linear-gradient(135deg, #001f3f 0%, #003d7a 50%, #001529 100%);
            --navy-gradient-light: linear-gradient(135deg, #003d7a 0%, #0056b3 100%);
            --white: #ffffff;
            --white-off: #f8f9fa;
            --text-primary: #001f3f;
            --text-secondary: #6c757d;
            --text-muted: #8d8d8d;
            --border-color: rgba(0, 31, 63, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8f0f7 100%);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8f0f7 100%);
            position: relative;
        }

        .dashboard-sidebar {
            width: 280px;
            min-width: 280px;
            max-width: 280px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 31, 63, 0.05);
            transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out, max-width 0.3s ease-in-out, left 0.3s ease-in-out;
            margin: 1.5rem 0;
            border-radius: 0 24px 24px 0;
            flex-shrink: 0;
            position: fixed;
            left: 1.5rem;
            top: 0;
            height: 100vh;
            overflow: hidden !important;
            overflow-y: hidden !important;
            overflow-x: hidden !important;
            z-index: 100;
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }

        /* Hide scrollbar completely - Webkit browsers */
        .dashboard-sidebar::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
        }

        /* Ensure child elements don't scroll */
        .dashboard-sidebar .sidebar-nav {
            overflow: hidden !important;
            overflow-y: hidden !important;
            overflow-x: hidden !important;
        }

        .dashboard-sidebar .sidebar-footer {
            overflow: hidden !important;
            overflow-y: hidden !important;
            overflow-x: hidden !important;
        }

        .dashboard-sidebar .sidebar-header {
            overflow: hidden !important;
        }

        /* Navy Blue Gradient Blurry Lines Background */
        .dashboard-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(135deg, rgba(0, 31, 63, 0.08) 0%, transparent 50%),
                linear-gradient(45deg, rgba(0, 61, 122, 0.06) 0%, transparent 60%),
                linear-gradient(225deg, rgba(0, 21, 41, 0.05) 0%, transparent 70%),
                linear-gradient(315deg, rgba(0, 86, 179, 0.04) 0%, transparent 80%);
            background-size: 200% 200%, 180% 180%, 160% 160%, 140% 140%;
            background-position: 0% 0%, 20% 20%, 40% 40%, 60% 60%;
            filter: blur(40px);
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
            border-radius: inherit;
        }

        .dashboard-sidebar > * {
            position: relative;
            z-index: 1;
        }

        @media (min-width: 1201px) {
            .dashboard-sidebar {
                border-radius: 24px 0 0 24px;
            }
        }

        .dashboard-sidebar .sidebar-header {
            padding: 0;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dashboard-sidebar .logo-image {
            width: 80px !important;
            height: auto !important;
            filter: drop-shadow(0 2px 4px rgba(0, 31, 63, 0.1));
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        .sidebar-nav .nav-item {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9375rem;
            letter-spacing: 0.01em;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .sidebar-nav .nav-item i {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: inherit;
        }

        .sidebar-nav .nav-item:hover {
            background: linear-gradient(135deg, rgba(0, 31, 63, 0.05) 0%, rgba(0, 61, 122, 0.05) 100%);
            color: var(--navy-primary);
        }

        .sidebar-nav .nav-item.active {
            background: var(--navy-gradient);
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 31, 63, 0.2);
        }

        .sidebar-nav .nav-item.active i {
            color: #fff;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(0, 31, 63, 0.03) 0%, rgba(0, 61, 122, 0.03) 100%);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            min-height: auto;
        }

        .sidebar-user-profile {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
            color: var(--text-primary);
            text-decoration: none;
            margin-bottom: 0;
            width: 100%;
        }

        .sidebar-user-profile-top {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            width: 100%;
            margin-bottom: 0.75rem;
            text-decoration: none;
            color: inherit;
        }

        .sidebar-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--navy-gradient);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: #fff;
            box-shadow: 0 4px 8px rgba(0, 31, 63, 0.15);
            flex-shrink: 0;
        }

        .sidebar-user-details {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .sidebar-user-details .sidebar-user-name {
            font-weight: 700;
            font-size: 0.9375rem;
            color: var(--text-primary);
            line-height: 1.3;
            margin-bottom: 0.25rem;
        }

        .sidebar-user-details .sidebar-user-role {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .sidebar-user-actions {
            width: 100%;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: block;
            visibility: visible;
            opacity: 1;
        }

        .sidebar-action-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            color: #ff0000 !important;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            width: 100%;
            background: #ffffff;
            border: 1px solid #ff0000 !important;
            cursor: pointer;
        }

        .sidebar-action-item:hover {
            color: #ffffff !important;
            background: #ff0000 !important;
            border-color: #ff0000 !important;
        }

        .sidebar-action-item i {
            font-size: 0.875rem;
            color: #ff0000 !important;
        }

        .sidebar-action-item:hover i {
            color: #ffffff !important;
        }

        /* Collapsed Sidebar */
        .dashboard-sidebar.collapsed {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            padding: 2rem 0.75rem;
            left: 1.5rem;
        }

        .dashboard-sidebar.collapsed ~ .dashboard-main {
            margin-left: calc(80px + 1.5rem + 1.5rem);
        }

        .dashboard-sidebar.collapsed .sidebar-header {
            padding: 0;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dashboard-sidebar.collapsed .logo-image {
            width: 48px !important;
            height: auto !important;
        }

        .dashboard-sidebar.collapsed .sidebar-nav {
            gap: 0.5rem;
            padding: 0;
        }

        .dashboard-sidebar.collapsed .sidebar-nav .nav-item {
            justify-content: center;
            padding: 0.875rem;
            margin: 0;
        }

        .dashboard-sidebar.collapsed .sidebar-nav .nav-item i {
            margin: 0;
            font-size: 1.125rem;
        }

        .dashboard-sidebar.collapsed .sidebar-nav .nav-item span {
            display: none;
        }

        .dashboard-sidebar.collapsed .sidebar-footer {
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .dashboard-sidebar.collapsed .sidebar-user-profile {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .dashboard-sidebar.collapsed .sidebar-user-profile-top {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .dashboard-sidebar.collapsed .sidebar-user-details {
            display: none;
        }

        .dashboard-sidebar.collapsed .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            font-size: 0.875rem;
        }

        .dashboard-sidebar.collapsed .sidebar-user-actions {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .dashboard-sidebar.collapsed .sidebar-action-item {
            justify-content: center;
            padding: 0.75rem;
            width: 100%;
        }

        .dashboard-sidebar.collapsed .sidebar-action-item span {
            display: none;
        }

        .dashboard-sidebar.collapsed .sidebar-action-item i {
            margin: 0;
            font-size: 1.125rem;
        }

        .dashboard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-radius: 24px 0 0 24px;
            margin: 1.5rem 1.5rem 1.5rem 0;
            margin-left: calc(280px + 1.5rem + 1.5rem);
            box-shadow: 0 4px 20px rgba(0, 31, 63, 0.08);
            overflow: hidden;
            min-width: 0;
            position: relative;
            z-index: 0;
        }

        @media (min-width: 1201px) {
            .dashboard-main {
                border-radius: 24px;
                margin: 1.5rem;
                margin-left: calc(280px + 1.5rem + 1.5rem);
            }
        }

        .dashboard-header {
            background: #ffffff;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .dashboard-nav { padding: 1rem 0; }

        .dashboard-header .logo h1 {
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: #0f172a;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-portal-profile {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            background: #f8fafc;
            border: 1px solid var(--brand-border);
            padding: 0.45rem 0.75rem;
            border-radius: 999px;
            position: relative;
            cursor: pointer;
            min-width: 190px;
        }

        .user-portal-profile .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--brand-gradient);
            color: #fff;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(45,127,249,0.25);
        }

        .user-portal-profile .user-meta {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .user-meta .user-name { font-weight: 700; color: #0f172a; }
        .user-meta .user-role { font-size: 0.8rem; color: var(--brand-muted); }

        .profile-caret {
            background: none;
            border: none;
            color: #475569;
            padding: 0;
            display: inline-flex;
            align-items: center;
        }

        .profile-dropdown {
            position: absolute;
            top: 110%;
            right: 0;
            background: #ffffff;
            border: 1px solid var(--brand-border);
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            border-radius: 12px;
            min-width: 200px;
            padding: 0.5rem 0;
            display: none;
        }

        .profile-dropdown a,
        .profile-dropdown button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            text-align: left;
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
        }

        .profile-dropdown a:hover,
        .profile-dropdown button:hover { background: #f8fafc; }

        .user-portal-profile.open .profile-dropdown { display: block; }

        .dashboard-content { padding: 2rem 1.5rem; }
        .transfer-card { border: 1px solid var(--brand-border); border-radius: 16px; box-shadow: 0 6px 16px rgba(15,23,42,0.06); }
        .wizard-progress { background: #fff; border: 1px solid var(--brand-border); border-radius: 16px; padding: 1rem; }

        .btn-primary,
        a.btn-primary,
        button.btn-primary {
            background: var(--navy-gradient) !important;
            border: none !important;
            color: #fff !important;
            box-shadow: 0 4px 12px rgba(0, 31, 63, 0.3) !important;
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .btn-primary:hover,
        a.btn-primary:hover,
        button.btn-primary:hover {
            background: var(--navy-gradient-light) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 31, 63, 0.4) !important;
        }

        .wizard-actions {
            display: flex !important;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-color);
        }

        .wizard-actions .btn-primary,
        .form-actions .btn-primary,
        .wizard-actions button.btn-primary {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: var(--navy-gradient) !important;
            color: #fff !important;
        }

        .btn-secondary,
        a.btn-secondary {
            border: 2px solid #2d7ff9;
            color: #2d7ff9;
            background: #ffffff;
        }

        @media (max-width: 1200px) {
            .dashboard-sidebar {
                left: 1rem;
            }

            .dashboard-main {
                margin: 1rem 1rem 1rem 0;
                margin-left: calc(280px + 1rem + 1rem);
                border-radius: 20px 0 0 0;
            }

            .dashboard-content {
                padding: 1.75rem 2rem;
            }

            .dashboard-sidebar.collapsed ~ .dashboard-main {
                margin-left: calc(80px + 1rem + 1rem);
            }
        }

        /* Mobile Hamburger Menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
            z-index: 1001;
            position: relative;
            pointer-events: auto;
        }

        .mobile-menu-toggle:hover {
            color: var(--navy-primary);
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .dashboard-sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease-in-out;
                box-shadow: 2px 0 10px rgba(0, 31, 63, 0.1);
                margin: 0;
                border-radius: 0;
            }

            .dashboard-sidebar.mobile-open {
                left: 0;
            }

            .dashboard-main {
                margin-left: 0 !important;
                width: 100%;
            }

            .dashboard-sidebar.collapsed {
                left: -100%;
            }

            .dashboard-sidebar.collapsed.mobile-open {
                left: 0;
            }

            /* Overlay when sidebar is open */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        @media (max-width: 900px) {
            .dashboard-content {
                padding: 1.5rem 1.25rem;
            }

            .nav-actions {
                gap: 0.75rem;
            }

            .user-portal-profile {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="logo" id="logoToggle" role="button" aria-label="Toggle sidebar" tabindex="0">
                    <img src="css/logo.png" alt="LTO Logo" class="logo-image">
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="owner-dashboard.html" class="nav-item">
                    <i class="fas fa-th-large"></i>
                    <span>My Dashboard</span>
                </a>
                <a href="owner-dashboard.html#applications" class="nav-item">
                    <i class="fas fa-folder-open"></i>
                    <span>My Applications</span>
                </a>
                <a href="my-vehicle-ownership.html" class="nav-item">
                    <i class="fas fa-warehouse"></i>
                    <span>My Vehicles</span>
                </a>
                <a href="registration-wizard.html" class="nav-item">
                    <i class="fas fa-file-circle-plus"></i>
                    <span>New Registration</span>
                </a>
                <a href="transfer-ownership.html" class="nav-item active">
                    <i class="fas fa-arrows-rotate"></i>
                    <span>Transfer of Ownership</span>
                </a>
            </nav>
            
            <!-- Sidebar Footer with User Info -->
            <!-- Sidebar Footer with User Info -->
            <div class="sidebar-footer">
                <div class="sidebar-user-profile">
                    <a href="settings.html" class="sidebar-user-profile-top">
                        <div class="sidebar-user-avatar" id="sidebarUserAvatar">GU</div>
                        <div class="sidebar-user-details">
                            <span class="sidebar-user-name" id="sidebarUserName">Loading...</span>
                            <span class="sidebar-user-role" id="sidebarUserRole">Loading...</span>
                        </div>
                    </a>
                    <div class="sidebar-user-actions">
                        <a href="#" class="sidebar-action-item" id="sidebarLogoutBtn">
                            <i class="fas fa-right-from-bracket"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="dashboard-main">
            <header class="dashboard-header">
                <div class="container">
                    <div class="dashboard-nav">
                        <div class="nav-left">
                            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                                <i class="fas fa-bars"></i>
                            </button>
                            <div class="logo">
                                <h1>Transfer of Ownership</h1>
                            </div>
                        </div>
                        <div class="nav-right">
                            <!-- Header user dropdown removed per UI requirements -->
                        </div>
                    </div>
                </div>
            </header>

            <main class="dashboard-content">
                <div class="container">
                    <!-- Progress Tracker -->
                    <div class="wizard-progress transfer-progress">
                        <div class="progress-step active" data-step="1">
                            <div class="step-number"><i class="fas fa-user-shield"></i></div>
                            <div class="step-label">Seller Info</div>
                        </div>
                        <div class="progress-step" data-step="2">
                            <div class="step-number"><i class="fas fa-user-plus"></i></div>
                            <div class="step-label">Buyer Info</div>
                        </div>
                        <div class="progress-step" data-step="3">
                            <div class="step-number"><i class="fas fa-car-side"></i></div>
                            <div class="step-label">Vehicle Info</div>
                        </div>
                        <div class="progress-step" data-step="4">
                            <div class="step-number"><i class="fas fa-file-upload"></i></div>
                            <div class="step-label">Upload Docs</div>
                        </div>
                        <div class="progress-step" data-step="5">
                            <div class="step-number"><i class="fas fa-check-circle"></i></div>
                            <div class="step-label">Submit</div>
                        </div>
                    </div>

                    <!-- Wizard Steps -->
                    <div class="wizard-steps">
                        <!-- Step 1 -->
                        <section id="to-step-1" class="wizard-step active">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-user-shield"></i></div>
                                        <div>
                                            <h2>Seller Information</h2>
                                            <p>Pre-filled from your profile; update contact and address if needed.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError" class="wizard-error"></div>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Seller Full Name</label>
                                            <input type="text" id="sellerName" placeholder="Auto-filled from profile">
                                        </div>
                                        <div class="form-group">
                                            <label>Seller Address</label>
                                            <input type="text" id="sellerAddress" placeholder="Street, City, Province">
                                        </div>
                                        <div class="form-group">
                                            <label>Seller Contact Number</label>
                                            <input type="tel" id="sellerContact" placeholder="+63 912 345 6789">
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-primary" onclick="toNextStep(2)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 2 -->
                        <section id="to-step-2" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-user-plus"></i></div>
                                        <div>
                                            <h2>Buyer Information</h2>
                                            <p>Collect buyer contact details.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError2" class="wizard-error"></div>
                                    <div class="form-grid">
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label>Buyer Email <span class="required">*</span></label>
                                            <input type="email" id="buyerEmail" placeholder="buyer@email.com" required>
                                            <small class="form-text text-muted">Enter the email address of the buyer. They will receive a notification to accept or reject the transfer request.</small>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(1)">Previous</button>
                                        <button class="btn-primary" onclick="toNextStep(3)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 3 -->
                        <section id="to-step-3" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-car-side"></i></div>
                                        <div>
                                            <h2>Vehicle Information</h2>
                                            <p>Identify the vehicle being transferred.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError3" class="wizard-error"></div>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Plate Number</label>
                                            <input type="text" id="toPlateNumber" placeholder="ABC-1234">
                                        </div>
                                        <div class="form-group">
                                            <label>Engine Number</label>
                                            <input type="text" id="toEngineNumber" placeholder="e.g., 2NR-FE123456">
                                        </div>
                                        <div class="form-group">
                                            <label>Chassis Number</label>
                                            <input type="text" id="toChassisNumber" placeholder="e.g., JT1234567890">
                                        </div>
                                        <div class="form-group">
                                            <label>Vehicle Type</label>
                                            <select id="toVehicleType">
                                                <option value="">Select Type</option>
                                                <option>Passenger Car</option>
                                                <option>Motorcycle</option>
                                                <option>Utility Vehicle</option>
                                                <option>Truck</option>
                                                <option>Bus</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                OR Number 
                                                <span class="orcr-info-badge" id="orBadge" style="display: none;">
                                                    <i class="fas fa-lock"></i> System Assigned
                                                </span>
                                            </label>
                                            <input type="text" id="toOrNumber" placeholder="e.g., OR-2025-000001" readonly>
                                            <small class="form-text text-muted" id="orHelpText">
                                                This will be auto-filled when you select a registered vehicle.
                                            </small>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                CR Number 
                                                <span class="orcr-info-badge" id="crBadge" style="display: none;">
                                                    <i class="fas fa-lock"></i> System Assigned
                                                </span>
                                            </label>
                                            <input type="text" id="toCrNumber" placeholder="e.g., CR-2025-000001" readonly>
                                            <small class="form-text text-muted" id="crHelpText">
                                                This will be auto-filled when you select a registered vehicle.
                                            </small>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(2)">Previous</button>
                                        <button class="btn-primary" onclick="toNextStep(4)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 4: Document Upload (Same structure as registration-wizard.html) -->
                        <section id="to-step-4" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-file-upload"></i></div>
                                        <div>
                                            <h2>Upload Required Documents</h2>
                                            <p>Upload the required documents. PDFs, JPG, PNG are accepted (max 10MB each).</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError4" class="wizard-error"></div>
                                    
                                    <!-- DEBUG: Test button to verify file input works -->
                                    <div style="background: #fff3cd; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ffc107;">
                                        <strong>🔧 Debug Test:</strong> 
                                        <button type="button" onclick="testFileInput()" style="margin-left: 10px; padding: 5px 15px; cursor: pointer;">
                                            Test File Dialog
                                        </button>
                                        <span id="debug-result" style="margin-left: 10px;"></span>
                                    </div>
                                    
                                    <div class="transfer-upload-section">
                                        <h3>Required Documents</h3>
                                        
                                        <!-- Deed of Sale -->
                                        <div class="transfer-upload-item" id="upload-item-deedOfSale">
                                            <div class="transfer-upload-info">
                                                <h4>📝 Deed of Sale <span style="color: #e74c3c;">*</span></h4>
                                                <p>Notarized deed of sale document</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="deedOfSale" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'deedOfSale')" required>
                                                <label for="deedOfSale" class="transfer-upload-label" id="label-deedOfSale">
                                                    <span class="transfer-upload-icon">📄</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-deedOfSale"></div>
                                            </div>
                                        </div>

                                        <!-- Seller Valid ID -->
                                        <div class="transfer-upload-item" id="upload-item-sellerId">
                                            <div class="transfer-upload-info">
                                                <h4>🪪 Seller Valid ID <span style="color: #e74c3c;">*</span></h4>
                                                <p>Government-issued ID of the seller</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="sellerId" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'sellerId')">
                                                <label for="sellerId" class="transfer-upload-label" id="label-sellerId">
                                                    <span class="transfer-upload-icon">🆔</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-sellerId"></div>
                                            </div>
                                        </div>

                                        <!-- OR/CR REMOVED: Latest OR/CR is not required for transfer requests.
                                             Every registered vehicle already has OR/CR linked in the system.
                                             When transfer is completed, a new OR/CR will be automatically generated
                                             for the new owner using the registration certificate generator. -->
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(3)">Previous</button>
                                        <button class="btn-primary" onclick="toNextStep(5)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 5: Review & Submit -->
                        <section id="to-step-5" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-clipboard-check"></i></div>
                                        <div>
                                            <h2>Review & Submit</h2>
                                            <p>Confirm all details before submission.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="summary-grid">
                                        <div class="summary-card">
                                            <h4><i class="fas fa-user-shield"></i> Seller Details</h4>
                                            <ul>
                                                <li><strong>Name:</strong> <span id="summarySellerName">Auto-filled</span></li>
                                                <li><strong>Address:</strong> <span id="summarySellerAddress">—</span></li>
                                                <li><strong>Contact:</strong> <span id="summarySellerContact">—</span></li>
                                            </ul>
                                        </div>
                                        <div class="summary-card">
                                            <h4><i class="fas fa-user-plus"></i> Buyer Details</h4>
                                            <ul>
                                                <li><strong>Email:</strong> <span id="summaryBuyerEmail">—</span></li>
                                            </ul>
                                        </div>
                                        <div class="summary-card">
                                            <h4><i class="fas fa-car"></i> Vehicle Details</h4>
                                            <ul>
                                                <li><strong>Plate No.:</strong> <span id="summaryPlate">—</span></li>
                                                <li><strong>Engine No.:</strong> <span id="summaryEngine">—</span></li>
                                                <li><strong>Chassis No.:</strong> <span id="summaryChassis">—</span></li>
                                                <li><strong>Type:</strong> <span id="summaryType">—</span></li>
                                                <li><strong>OR No.:</strong> <span id="summaryOr">—</span></li>
                                                <li><strong>CR No.:</strong> <span id="summaryCr">—</span></li>
                                            </ul>
                                        </div>
                                        <div class="summary-card">
                                            <h4><i class="fas fa-file-alt"></i> Uploaded Documents</h4>
                                            <ul id="summaryUploads">
                                                <!-- Documents will be populated dynamically -->
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(4)">Previous</button>
                                        <button class="btn-primary" onclick="submitTransfer()">Submit Request</button>
                                        <button class="btn-secondary" onclick="cancelTransfer()">Cancel</button>
                                    </div>
                                    <div class="confirmation-message" id="confirmationMessage" style="display:none;">
                                        <i class="fas fa-check-circle"></i>
                                        <div>
                                            <h4>Request Submitted</h4>
                                            <p>Your Transfer of Ownership request has been successfully sent to LTO for review.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script src="js/auth-utils.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/mobile-nav.js"></script>
    <script src="js/document-upload-utils.js"></script>
    <script>
        // DEBUG: Log immediately when script loads
        console.log('🚀 transfer-ownership.html script starting...');

        // Transfer data storage
        let transferData = {
            seller: {},
            buyer: {},
            vehicle: null,
            vehicleId: null,
            documents: {}
        };
        let userVehicles = [];
        let currentToStep = 1;
        // Note: apiClient is already declared globally in api-client.js

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📄 DOMContentLoaded fired');
            
            // ===== AUTHENTICATION CHECK - MUST BE FIRST =====
            if (typeof AuthUtils !== 'undefined') {
                const user = AuthUtils.getCurrentUser();
                if (!user) {
                    console.log('❌ Not authenticated, redirecting to login...');
                    window.location.href = 'login-signup.html';
                    return;
                }
                console.log('✅ User authenticated:', user.email);
            } else {
                console.error('❌ AuthUtils not loaded');
                window.location.href = 'login-signup.html';
                return;
            }
            // ================================================
            
            try {
                // Use global apiClient from api-client.js (already loaded)
                console.log('✅ Using global apiClient:', typeof window.apiClient);
            
            // Sidebar toggle and state (desktop)
            const sidebar = document.querySelector('.dashboard-sidebar');
            const logoToggle = document.getElementById('logoToggle');

            const savedSidebarState = localStorage.getItem('ownerSidebarCollapsed');
            if (sidebar && savedSidebarState === 'true' && window.innerWidth > 1024) {
                sidebar.classList.add('collapsed');
            }

            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                if (!sidebar || window.innerWidth <= 1024) return;
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('ownerSidebarCollapsed', isCollapsed ? 'true' : 'false');
            }

            if (logoToggle && sidebar && window.innerWidth > 1024) {
                logoToggle.addEventListener('click', toggleSidebar);
                logoToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        toggleSidebar(e);
                    }
                });
            }

            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            function toggleMobileSidebar() {
                if (sidebar && window.innerWidth <= 1024) {
                    sidebar.classList.toggle('mobile-open');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.toggle('active');
                    }
                    document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
                }
            }

            function closeMobileSidebar() {
                if (sidebar) {
                    sidebar.classList.remove('mobile-open');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.remove('active');
                    }
                    document.body.style.overflow = '';
                }
            }

            if (mobileMenuToggle) {
                console.log('Mobile menu toggle button found, attaching event listener');
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile menu toggle clicked');
                    toggleMobileSidebar();
                });
                // Also add touchstart for better mobile support
                mobileMenuToggle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile menu toggle touched');
                    toggleMobileSidebar();
                });
            } else {
                console.warn('Mobile menu toggle button not found!');
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    closeMobileSidebar();
                });
            }

            // Close sidebar when clicking on nav items (mobile)
            const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 1024) {
                        closeMobileSidebar();
                    }
                });
            });

            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (window.innerWidth > 1024) {
                        closeMobileSidebar();
                    }
                }, 250);
            });

            // Update sidebar user info
            updateSidebarUserInfo();
            console.log('✅ Sidebar user info updated');
            
            // Load seller info from profile
            await loadSellerInfo();
            console.log('✅ Seller info loaded');
            
            // Load user's vehicles
            await loadUserVehicles();
            console.log('✅ User vehicles loaded');
            
            // Initialize file upload handlers
            initializeFileUploads();
            console.log('✅ All initialization complete');
            
            
            } catch (error) {
                console.error('❌ Initialization error:', error);
            }
        });
        

        function updateSidebarUserInfo() {
            if (typeof AuthUtils !== 'undefined') {
                const user = AuthUtils.getCurrentUser();
                if (user) {
                    const sidebarUserNameEl = document.getElementById('sidebarUserName');
                    const sidebarUserRoleEl = document.getElementById('sidebarUserRole');
                    const sidebarUserAvatarEl = document.getElementById('sidebarUserAvatar');
                    
                    if (sidebarUserNameEl) sidebarUserNameEl.textContent = AuthUtils.getUserDisplayName();
                    if (sidebarUserRoleEl) sidebarUserRoleEl.textContent = 'Vehicle Owner';
                    if (sidebarUserAvatarEl) sidebarUserAvatarEl.textContent = AuthUtils.getUserInitials();
                } else {
                    window.location.href = 'login-signup.html';
                }
            }
            
            // Logout handler
            const logoutBtn = document.getElementById('sidebarLogoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof AuthUtils !== 'undefined') {
                        AuthUtils.logout();
                    }
                    window.location.href = 'login-signup.html';
                });
            }
        }

        async function loadSellerInfo() {
            try {
                // Fetch full profile from API to get phone and other details
                const profileResponse = await window.apiClient.get('/api/auth/profile');
                const user = profileResponse.success ? profileResponse.user : AuthUtils.getCurrentUser();
                
                if (user) {
                    const sellerNameEl = document.getElementById('sellerName');
                    const sellerAddressEl = document.getElementById('sellerAddress');
                    const sellerContactEl = document.getElementById('sellerContact');
                    
                    // Set seller name from profile (editable)
                    const displayName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                    if (sellerNameEl) {
                        sellerNameEl.value = displayName;
                        sellerNameEl.removeAttribute('disabled'); // Make editable
                    }
                    
                    // Auto-fill phone if available (editable)
                    if (sellerContactEl && user.phone) {
                        sellerContactEl.value = user.phone;
                    }
                    
                    // Auto-fill address if available (editable)
                    if (sellerAddressEl && user.address) {
                        sellerAddressEl.value = user.address;
                        sellerAddressEl.classList.add('auto-filled');
                    }
                    
                    // Store seller data
                    transferData.seller = {
                        id: user.id || user.userId,
                        name: displayName,
                        email: user.email,
                        phone: user.phone || ''
                    };
                }
            } catch (error) {
                console.error('Error loading seller info:', error);
                // Fallback to current user if API fails
                const user = AuthUtils.getCurrentUser();
                if (user) {
                    const sellerNameEl = document.getElementById('sellerName');
                    if (sellerNameEl) {
                        const displayName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                        sellerNameEl.value = displayName;
                        sellerNameEl.removeAttribute('disabled');
                    }
                }
            }
        }

        async function loadUserVehicles() {
            try {
                const response = await window.apiClient.get('/api/vehicles/my-vehicles');
                if (response.success && response.vehicles) {
                    // Include vehicles that are fully registered/approved
                    userVehicles = response.vehicles.filter(v => v.status === 'REGISTERED' || v.status === 'APPROVED');
                    populateVehicleSelector();
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        function populateVehicleSelector() {
            // Add vehicle selector to step 3
            const vehicleContainer = document.querySelector('#to-step-3 .form-grid');
            if (!vehicleContainer) return;
            
            // Check if selector already exists
            if (document.getElementById('vehicleSelector')) return;
            
            // Create vehicle selector
            const selectorHTML = `
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Select Your Vehicle</label>
                    <select id="vehicleSelector" onchange="selectVehicle(this.value)">
                        <option value="">-- Select a registered vehicle --</option>
                        ${userVehicles.map(v => `
                            <option value="${v.id}">
                                ${v.plate_number || v.plateNumber || 'N/A'} - ${v.make} ${v.model} ${v.year}
                            </option>
                        `).join('')}
                    </select>
                    ${userVehicles.length === 0 ? '<small style="color: #e74c3c;">No registered vehicles found. You can only transfer registered vehicles.</small>' : ''}
                </div>
            `;
            
            vehicleContainer.insertAdjacentHTML('afterbegin', selectorHTML);
            
            // Check if vehicle was pre-selected from vehicle list page
            const selectedVehicleId = sessionStorage.getItem('selectedVehicleId');
            if (selectedVehicleId) {
                const vehicle = userVehicles.find(v => v.id === selectedVehicleId);
                if (vehicle) {
                    // Auto-select the vehicle
                    const selector = document.getElementById('vehicleSelector');
                    if (selector) {
                        selector.value = selectedVehicleId;
                        selectVehicle(selectedVehicleId);
                        
                        // Show notification
                        if (typeof ToastNotification !== 'undefined') {
                            ToastNotification.show(`Vehicle ${vehicle.plate_number || vehicle.plateNumber || ''} pre-selected`, 'info');
                        }
                    }
                }
                // Clear sessionStorage
                sessionStorage.removeItem('selectedVehicleId');
                sessionStorage.removeItem('selectedVehiclePlate');
            }
        }

        function selectVehicle(vehicleId) {
            const vehicle = userVehicles.find(v => v.id === vehicleId);
            if (vehicle) {
                transferData.vehicleId = vehicleId;
                transferData.vehicle = vehicle;
                
                // Auto-fill vehicle fields
                document.getElementById('toPlateNumber').value = vehicle.plate_number || vehicle.plateNumber || '';
                document.getElementById('toEngineNumber').value = vehicle.engine_number || vehicle.engineNumber || '';
                document.getElementById('toChassisNumber').value = vehicle.chassis_number || vehicle.chassisNumber || vehicle.vin || '';
                document.getElementById('toVehicleType').value = vehicle.vehicle_type || vehicle.vehicleType || '';
                
                // Auto-fill separate OR and CR Numbers from vehicle record
                const orField = document.getElementById('toOrNumber');
                const crField = document.getElementById('toCrNumber');
                const orBadge = document.getElementById('orBadge');
                const crBadge = document.getElementById('crBadge');
                const orHelpText = document.getElementById('orHelpText');
                const crHelpText = document.getElementById('crHelpText');
                
                // Get separate OR and CR numbers (new format)
                const orNumber = vehicle.or_number || vehicle.orNumber || '';
                const crNumber = vehicle.cr_number || vehicle.crNumber || '';
                // Backward compatibility
                const orCrNumber = vehicle.or_cr_number || vehicle.orCrNumber || vehicle.orcr_number || '';
                
                if (orField) {
                    orField.value = orNumber || (orCrNumber ? orCrNumber.replace('ORCR-', 'OR-') : '');
                    if (orNumber || orCrNumber) {
                        orField.style.backgroundColor = '#f0f8ff';
                        if (orBadge) orBadge.style.display = 'inline-block';
                        if (orHelpText) orHelpText.style.display = 'none';
                    } else {
                        if (orBadge) orBadge.style.display = 'none';
                        if (orHelpText) {
                            orHelpText.style.display = 'block';
                            orHelpText.textContent = 'No OR number found for this vehicle.';
                        }
                    }
                }
                
                if (crField) {
                    crField.value = crNumber || (orCrNumber ? orCrNumber.replace('ORCR-', 'CR-') : '');
                    if (crNumber || orCrNumber) {
                        crField.style.backgroundColor = '#f0f8ff';
                        if (crBadge) crBadge.style.display = 'inline-block';
                        if (crHelpText) crHelpText.style.display = 'none';
                    } else {
                        if (crBadge) crBadge.style.display = 'none';
                        if (crHelpText) {
                            crHelpText.style.display = 'block';
                            crHelpText.textContent = 'No CR number found for this vehicle.';
                        }
                    }
                }
                
                // Make other fields readonly since they come from the system
                document.getElementById('toPlateNumber').readOnly = true;
                document.getElementById('toEngineNumber').readOnly = true;
                document.getElementById('toChassisNumber').readOnly = true;
                
                // Log for debugging
                console.log('✅ Vehicle selected:', {
                    vehicleId,
                    plateNumber: vehicle.plate_number || vehicle.plateNumber,
                    orCrNumber: vehicle.or_cr_number || vehicle.orCrNumber || 'N/A'
                });
            }
        }

        function initializeFileUploads() {
            console.log('🔧 Initializing file upload handlers...');
            
            // Add click listeners to debug and ensure they work
            const docTypes = ['deedOfSale', 'sellerId', 'orCr']; // Seller documents only (OR/CR optional)
            
            docTypes.forEach(docType => {
                const input = document.getElementById(docType);
                const label = document.getElementById(`label-${docType}`);
                
                console.log(`📁 ${docType}: input found = ${!!input}, label found = ${!!label}`);
                
                if (input) {
                    console.log(`   Input ID: ${input.id}, type: ${input.type}, accept: ${input.accept}`);
                }
                
                if (label) {
                    console.log(`   Label for: ${label.getAttribute('for')}`);
                    
                    // WORKAROUND: Directly trigger file input on label click
                    label.addEventListener('click', function(e) {
                        console.log(`👆 Label clicked for: ${docType}`);
                        e.preventDefault(); // Prevent default label behavior
                        e.stopPropagation();
                        
                        // Programmatically click the file input
                        if (input) {
                            console.log(`🖱️ Programmatically clicking input: ${docType}`);
                            input.click();
                        } else {
                            console.error(`❌ Input not found for: ${docType}`);
                        }
                    });
                }
                
                if (input) {
                    // Log when file input is clicked directly
                    input.addEventListener('click', function(e) {
                        console.log(`🖱️ File input click event: ${docType}`);
                    });
                    
                    // Log when file dialog opens/closes
                    input.addEventListener('change', function(e) {
                        console.log(`📂 File input changed: ${docType}`, this.files);
                    });
                }
            });
            
            console.log('✅ File upload handlers initialized');
        }

        // Handle file upload - using unified upload utility
        async function handleTransferUpload(input, docType) {
            console.log(`📤 handleTransferUpload called for: ${docType}`);
            
            if (!input.files || input.files.length === 0) {
                console.log(`⚠️ No files selected for ${docType}`);
                return;
            }
            
            const file = input.files[0];
            const label = document.getElementById(`label-${docType}`);
            const filenameDiv = document.getElementById(`filename-${docType}`);
            const uploadItem = document.getElementById(`upload-item-${docType}`);
            
            // Map transfer-specific doc types to logical document types
            // Transfer uses specific roles, but we need to map to logical types for upload
            // IMPORTANT: This map MUST include ALL upload slots in the form
            // If you add a new upload slot, you MUST add it here
            // Missing mappings will cause upload to fail (by design - fail-fast)
            const docTypeMap = {
                'deedOfSale': DocumentUploadUtils.DOCUMENT_TYPES.DEED_OF_SALE,
                'sellerId': DocumentUploadUtils.DOCUMENT_TYPES.SELLER_ID
                // OR/CR removed: Not required for transfer requests. System automatically generates new OR/CR after transfer completion.
            };
            
            // Fail-fast: Every upload slot MUST have a valid mapping
            const logicalDocType = docTypeMap[docType];
            
            if (!logicalDocType) {
                // This is a code bug - slot exists but no mapping
                console.error('[BUG] Upload slot missing from docTypeMap:', {
                    docType,
                    availableSlots: Object.keys(docTypeMap),
                    timestamp: new Date().toISOString()
                });
                
                // Show error to user
                if (label) {
                    label.innerHTML = `
                        <span class="transfer-upload-icon" style="color: #e74c3c;">❌</span>
                        <span class="transfer-upload-text" style="color: #e74c3c;">Configuration Error</span>
                    `;
                }
                
                showNotification(
                    `System error: Document type '${docType}' is not configured. Please contact support.`,
                    'error'
                );
                
                // Reset file input
                input.value = '';
                return; // Stop upload
            }
            
            // Show uploading state
            if (label) {
                label.innerHTML = `
                    <span class="transfer-upload-icon">⏳</span>
                    <span class="transfer-upload-text">Uploading...</span>
                `;
            }
            
            try {
                // Use unified upload utility
                const result = await DocumentUploadUtils.uploadDocument(logicalDocType, file, {
                    vehicleId: transferData.vehicleId,
                    onProgress: (progress) => {
                        // Optional: Update progress indicator
                        console.log(`Upload progress for ${docType}:`, progress);
                    }
                });
                
                if (result.success) {
                    // Store document info with transfer role
                    transferData.documents[docType] = {
                        id: result.document?.id || result.document?.document?.id,
                        filename: result.document?.originalName || file.name,
                        cid: result.document?.cid || result.document?.ipfsHash
                    };
                    
                    // Update UI to show success
                    if (label) {
                        label.classList.add('uploaded');
                        label.innerHTML = `
                            <span class="transfer-upload-icon">✅</span>
                            <span class="transfer-upload-text">Uploaded</span>
                        `;
                    }
                    if (uploadItem) {
                        uploadItem.classList.add('uploaded');
                    }
                    if (filenameDiv) {
                        filenameDiv.textContent = file.name;
                    }
                    
                    showNotification(`${file.name} uploaded successfully`, 'success');
                    console.log(`✅ Document uploaded successfully:`, {
                        docType,
                        logicalType: logicalDocType,
                        documentId: transferData.documents[docType].id
                    });
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                
                // Reset label on error
                if (label) {
                    label.classList.remove('uploaded');
                    label.innerHTML = `
                        <span class="transfer-upload-icon">📄</span>
                        <span class="transfer-upload-text">Choose File</span>
                    `;
                }
                if (filenameDiv) {
                    filenameDiv.innerHTML = `<span style="color: #e74c3c;">❌ ${error.message || 'Upload failed'}</span>`;
                }
                
                showNotification(`Upload failed: ${error.message || 'Unknown error'}`, 'error');
            }
        }

        function showWizardError(step, message) {
            const idMap = {1:'wizardError',2:'wizardError2',3:'wizardError3',4:'wizardError4'};
            const errorEl = document.getElementById(idMap[step] || 'wizardError');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            }
        }

        function clearWizardErrors() {
            document.querySelectorAll('.wizard-error').forEach(el => {
                el.textContent = '';
                el.classList.remove('show');
            });
            document.querySelectorAll('.transfer-card input, .transfer-card select').forEach(el => {
                el.classList.remove('invalid');
            });
        }

        function validateToStep(step) {
            clearWizardErrors();
            let valid = true;
            const markInvalid = (el) => { if (el) el.classList.add('invalid'); valid = false; };

            if (step === 1) {
                const addr = document.getElementById('sellerAddress');
                const contact = document.getElementById('sellerContact');
                if (!addr?.value.trim()) markInvalid(addr);
                if (!contact?.value.trim()) markInvalid(contact);
                if (!valid) showWizardError(1, 'Please complete seller address and contact before continuing.');
                
                // Store seller data
                transferData.seller.address = addr?.value.trim();
                transferData.seller.phone = contact?.value.trim();
            } else if (step === 2) {
                // NEW: Only require buyer email (simplified workflow)
                const buyerEmail = document.getElementById('buyerEmail');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!buyerEmail?.value.trim() || !emailRegex.test(buyerEmail.value.trim())) {
                    markInvalid(buyerEmail);
                    valid = false;
                }
                
                // Prevent seller from transferring to themselves
                if (typeof AuthUtils !== 'undefined') {
                    const currentUser = AuthUtils.getCurrentUser();
                    const currentUserEmail = currentUser?.email;
                    if (currentUserEmail && buyerEmail?.value.trim().toLowerCase() === currentUserEmail.toLowerCase()) {
                        markInvalid(buyerEmail);
                        showWizardError(2, 'You cannot transfer ownership to yourself. Please enter a different email address.');
                        return;
                    }
                }
                
                if (!valid) {
                    showWizardError(2, 'Please enter a valid buyer email address.');
                    return;
                }
                
                // Store only email - buyer will complete profile when they accept
                transferData.buyer = {
                    email: buyerEmail.value.trim()
                };
            } else if (step === 3) {
                const vehicleSelector = document.getElementById('vehicleSelector');
                if (!vehicleSelector?.value) {
                    showWizardError(3, 'Please select a vehicle to transfer.');
                    valid = false;
                }
                
                const plate = document.getElementById('toPlateNumber');
                const engine = document.getElementById('toEngineNumber');
                const chassis = document.getElementById('toChassisNumber');
                const type = document.getElementById('toVehicleType');
                const orNumber = document.getElementById('toOrNumber');
                const crNumber = document.getElementById('toCrNumber');
                
                // Validate required fields
                if (!plate?.value.trim()) markInvalid(plate);
                if (!chassis?.value.trim()) markInvalid(chassis);
                if (!orNumber?.value.trim()) markInvalid(orNumber);
                if (!crNumber?.value.trim()) markInvalid(crNumber);
                
                if (!valid) {
                    const missingFields = [];
                    if (!plate?.value.trim()) missingFields.push('Plate Number');
                    if (!chassis?.value.trim()) missingFields.push('Chassis Number');
                    if (!orNumber?.value.trim()) missingFields.push('OR Number');
                    if (!crNumber?.value.trim()) missingFields.push('CR Number');
                    showWizardError(3, `Please complete all required fields: ${missingFields.join(', ')}`);
                }
            } else if (step === 4) {
                // Check required documents (Seller documents only)
                const requiredDocs = ['deedOfSale', 'sellerId'];
                // Enhanced validation: Check that documents exist AND have IDs
                const missingDocs = requiredDocs.filter(doc => {
                    const docData = transferData.documents[doc];
                    return !docData || !docData.id;
                });
                
                if (missingDocs.length > 0) {
                    const docNames = {
                        'deedOfSale': 'Deed of Sale',
                        'sellerId': 'Seller ID'
                    };
                    const missingNames = missingDocs.map(d => docNames[d] || d).join(', ');
                    showWizardError(4, `Please upload all required documents: ${missingNames}`);
                    valid = false;
                }
                // Note: OR/CR is optional - can be pulled from vehicle record if vehicle is already registered
            }

            return valid;
        }

        function setToStep(targetStep) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.transfer-progress .progress-step').forEach(s => s.classList.remove('active'));
            const stepEl = document.getElementById(`to-step-${targetStep}`);
            const progressEl = document.querySelector(`.transfer-progress [data-step="${targetStep}"]`);
            if (stepEl) stepEl.classList.add('active');
            if (progressEl) progressEl.classList.add('active');
            currentToStep = targetStep;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update summary on step 5
            if (targetStep === 5) {
                updateSummary();
            }
        }

        function updateSummary() {
            // Seller
            document.getElementById('summarySellerName').textContent = transferData.seller.name || 'N/A';
            document.getElementById('summarySellerAddress').textContent = transferData.seller.address || 'N/A';
            document.getElementById('summarySellerContact').textContent = transferData.seller.phone || 'N/A';
            
            // Buyer (email only)
            document.getElementById('summaryBuyerEmail').textContent = transferData.buyer.email || 'N/A';
            
            // Vehicle
            const vehicle = transferData.vehicle;
            document.getElementById('summaryPlate').textContent = vehicle?.plate_number || vehicle?.plateNumber || 'N/A';
            document.getElementById('summaryEngine').textContent = vehicle?.engine_number || vehicle?.engineNumber || 'N/A';
            document.getElementById('summaryChassis').textContent = vehicle?.chassis_number || vehicle?.chassisNumber || vehicle?.vin || 'N/A';
            document.getElementById('summaryType').textContent = vehicle?.vehicle_type || vehicle?.vehicleType || 'N/A';
            
            // OR/CR Numbers - from vehicle object (separate OR and CR)
            const orNumber = vehicle?.or_number || vehicle?.orNumber || 'N/A';
            const crNumber = vehicle?.cr_number || vehicle?.crNumber || 'N/A';
            const orCrNumber = vehicle?.or_cr_number || vehicle?.orCrNumber || (orNumber !== 'N/A' && crNumber !== 'N/A' ? `${orNumber} / ${crNumber}` : 'N/A');
            
            // Update summary display elements
            const summaryOrEl = document.getElementById('summaryOr');
            const summaryCrEl = document.getElementById('summaryCr');
            const summaryOrCrEl = document.getElementById('summaryOrCr');
            
            if (summaryOrEl) summaryOrEl.textContent = orNumber;
            if (summaryCrEl) summaryCrEl.textContent = crNumber;
            if (summaryOrCrEl) summaryOrCrEl.textContent = orCrNumber;
            
            // Documents
            const uploadsList = document.getElementById('summaryUploads');
            if (uploadsList) {
                const docNames = {
                    'deedOfSale': 'Deed of Sale',
                    'sellerId': 'Seller Valid ID',
                    'orCr': 'Latest OR/CR (Optional)'
                };
                uploadsList.innerHTML = Object.entries(transferData.documents)
                    .map(([type, doc]) => `<li>✅ ${docNames[type] || type}: ${doc.filename}</li>`)
                    .join('') || '<li>No documents uploaded</li>';
            }
        }

        function toNextStep(targetStep) {
            const currentStep = targetStep - 1;
            if (!validateToStep(currentStep)) return;
            setToStep(targetStep);
        }

        function toPrevStep(targetStep) {
            setToStep(targetStep);
        }

        async function submitTransfer() {
            try {
                // Validate we have required data
                if (!transferData.vehicleId) {
                    showNotification('Please select a vehicle to transfer', 'error');
                    return;
                }
                
                if (!transferData.buyer.email) {
                    showNotification('Buyer information is incomplete', 'error');
                    return;
                }
                
                // Validate required documents are present (Seller documents only)
                const requiredDocs = ['deedOfSale', 'sellerId'];
                const missingDocs = requiredDocs.filter(doc => !transferData.documents[doc] || !transferData.documents[doc].id);
                
                if (missingDocs.length > 0) {
                    const docNames = {
                        'deedOfSale': 'Deed of Sale',
                        'sellerId': 'Seller ID'
                    };
                    showNotification(`Please upload all required documents: ${missingDocs.map(d => docNames[d] || d).join(', ')}`, 'error');
                    return;
                }
                
                // Prepare request data with explicit document roles (NEW APPROACH - Option A: email-based)
                const requestData = {
                    vehicleId: transferData.vehicleId,
                    buyerEmail: transferData.buyer.email,
                    // NEW: Explicit document roles (preferred) - Seller documents only
                    documents: {
                        deedOfSale: transferData.documents.deedOfSale?.id,
                        sellerId: transferData.documents.sellerId?.id,
                        orCr: transferData.documents.orCr?.id // Optional - can be pulled from vehicle record
                    }
                    // LEGACY: Keep documentIds for backward compatibility (will be ignored if documents is provided)
                    // documentIds: Object.values(transferData.documents)
                    //     .filter(d => d.id)
                    //     .map(d => d.id)
                };
                
                console.log('📤 Submitting transfer request with explicit document roles:', {
                    vehicleId: requestData.vehicleId,
                    documentCount: Object.keys(requestData.documents).length,
                    documents: requestData.documents
                });
                
                // Submit to API
                const response = await window.apiClient.post('/api/vehicles/transfer/requests', requestData);
                
                if (response.success) {
                    const confirmation = document.getElementById('confirmationMessage');
                    if (confirmation) {
                        confirmation.style.display = 'flex';
                        confirmation.innerHTML = `
                            <i class="fas fa-check-circle" style="color: #27ae60; font-size: 3rem;"></i>
                            <div>
                                <h4>Request Submitted Successfully!</h4>
                                <p>Your Transfer of Ownership request has been submitted for review.</p>
                                <p><strong>Request ID:</strong> ${response.transferRequest?.id?.substring(0, 8) || 'N/A'}</p>
                                <p>You will be notified when the request is processed.</p>
                                <button class="btn-primary" onclick="window.location.href='owner-dashboard.html'" style="margin-top: 15px;">
                                    Return to Dashboard
                                </button>
                            </div>
                        `;
                    }
                    
                    // Hide action buttons
                    const actions = document.querySelector('#to-step-5 .wizard-actions');
                    if (actions) actions.style.display = 'none';
                    
                    showNotification('Transfer request submitted successfully!', 'success');
                } else {
                    throw new Error(response.error || 'Failed to submit transfer request');
                }
            } catch (error) {
                console.error('Submit transfer error:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function cancelTransfer() {
            if (confirm('Are you sure you want to cancel? All entered data will be lost.')) {
                window.location.href = 'owner-dashboard.html';
            }
        }

        function showNotification(message, type = 'info') {
            if (typeof ToastNotification !== 'undefined') {
                ToastNotification.show(message, type);
            } else {
                alert(message);
            }
        }

        // DEBUG: Test function for file input
        function testFileInput() {
            console.log('🧪 Test button clicked');
            const resultSpan = document.getElementById('debug-result');
            
            // Create a temporary file input
            const testInput = document.createElement('input');
            testInput.type = 'file';
            testInput.accept = '.pdf,.jpg,.jpeg,.png';
            
            testInput.onchange = function() {
                console.log('🧪 Test file selected:', this.files[0]?.name);
                if (resultSpan) {
                    resultSpan.innerHTML = `<span style="color: green;">✅ File selected: ${this.files[0]?.name}</span>`;
                }
            };
            
            console.log('🧪 Triggering test file input click...');
            testInput.click();
            
            if (resultSpan) {
                resultSpan.innerHTML = '<span style="color: blue;">File dialog should be open...</span>';
            }
        }

        // DEBUG: Also expose a manual trigger function
        function manualTrigger(docType) {
            console.log(`🔧 Manual trigger for: ${docType}`);
            const input = document.getElementById(docType);
            if (input) {
                console.log(`   Found input, triggering click...`);
                input.click();
            } else {
                console.error(`   Input not found: ${docType}`);
            }
        }
    </script>
</body>
</html>
