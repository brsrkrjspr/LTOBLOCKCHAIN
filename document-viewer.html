<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewer - LTO Blockchain</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Document Viewer - Modern Design */
        .doc-viewer-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .doc-viewer-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .doc-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .doc-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .doc-header-title h1 {
            margin: 0;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .doc-header-title p {
            margin: 0;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
        }
        
        .doc-header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-action-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .header-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .header-action-btn.primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .doc-viewer-main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 80px);
        }
        
        /* Document List Sidebar */
        .doc-list-sidebar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 120px);
            position: sticky;
            top: 100px;
        }
        
        .doc-list-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .doc-list-header h3 {
            margin: 0 0 0.5rem 0;
            color: white;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .doc-list-header h3 i {
            color: #3498db;
        }
        
        .doc-count-badge {
            background: #3498db;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .doc-list-search {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .doc-search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
        }
        
        .doc-search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .doc-search-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .doc-list-items {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .doc-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
        }
        
        .doc-list-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .doc-list-item.active {
            background: rgba(52, 152, 219, 0.15);
            border-color: #3498db;
        }
        
        .doc-list-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .doc-list-icon.registration { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; }
        .doc-list-icon.insurance { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .doc-list-icon.emission { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
        .doc-list-icon.id { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; }
        .doc-list-icon.other { background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%); color: white; }
        
        .doc-list-info {
            flex: 1;
            min-width: 0;
        }
        
        .doc-list-name {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .doc-list-meta {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .doc-list-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .doc-list-status.verified { background: #27ae60; }
        .doc-list-status.pending { background: #f39c12; }
        .doc-list-status.error { background: #e74c3c; }
        
        /* Document Preview Area */
        .doc-preview-area {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .doc-preview-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .doc-preview-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .doc-preview-title h2 {
            margin: 0;
            color: white;
            font-size: 1.25rem;
        }
        
        .doc-verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .doc-preview-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .preview-action-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .preview-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .doc-preview-frame {
            flex: 1;
            background: #0f0f23;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            position: relative;
        }
        
        .doc-preview-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .doc-preview-frame img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .doc-preview-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
        }
        
        .doc-preview-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .doc-preview-placeholder p {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .doc-preview-placeholder small {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        
        .doc-preview-loading {
            text-align: center;
            color: white;
        }
        
        .doc-preview-loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Document Info Panel */
        .doc-info-panel {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
        }
        
        .doc-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .doc-info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .doc-info-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .doc-info-value {
            color: white;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        /* Empty State */
        .empty-doc-state {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }
        
        .empty-doc-state i {
            font-size: 4rem;
            color: rgba(255, 255, 255, 0.2);
            margin-bottom: 1.5rem;
        }
        
        .empty-doc-state h2 {
            color: white;
            margin: 0 0 0.5rem 0;
        }
        
        .empty-doc-state p {
            color: rgba(255, 255, 255, 0.5);
            margin: 0;
        }
        
        /* Mobile Responsive */
        @media (max-width: 900px) {
            .doc-viewer-main {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .doc-list-sidebar {
                position: relative;
                top: 0;
                max-height: none;
            }
            
            .doc-list-items {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            .doc-list-item {
                flex-shrink: 0;
                width: 200px;
                margin-bottom: 0;
            }
            
            .doc-header-content {
                flex-wrap: wrap;
            }
            
            .doc-header-right {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        @media (max-width: 480px) {
            .doc-viewer-header {
                padding: 1rem;
            }
            
            .doc-header-title h1 {
                font-size: 1.1rem;
            }
            
            .header-action-btn span {
                display: none;
            }
            
            .doc-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="doc-viewer-page">
    <header class="doc-viewer-header">
        <div class="doc-header-content">
            <div class="doc-header-left">
                <button class="back-btn" onclick="goBack()" title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="doc-header-title">
                    <h1>Document Viewer</h1>
                    <p id="vehicleInfo">Loading vehicle information...</p>
                </div>
            </div>
            <div class="doc-header-right">
                <button class="header-action-btn" onclick="downloadCurrentDocument()">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </button>
                <button class="header-action-btn" onclick="printDocument()">
                    <i class="fas fa-print"></i>
                    <span>Print</span>
                </button>
                <button class="header-action-btn primary" onclick="verifyOnBlockchain()">
                    <i class="fas fa-link"></i>
                    <span>Verify on Blockchain</span>
                </button>
            </div>
        </div>
    </header>
    
    <main class="doc-viewer-main" id="viewerMain">
        <!-- Document List Sidebar -->
        <aside class="doc-list-sidebar">
            <div class="doc-list-header">
                <h3><i class="fas fa-folder-open"></i> Documents</h3>
                <span class="doc-count-badge" id="docCount">0</span>
            </div>
            <div class="doc-list-search">
                <input type="text" class="doc-search-input" placeholder="Search documents..." onkeyup="filterDocuments(this.value)">
            </div>
            <div class="doc-list-items" id="docListItems">
                <!-- Documents will be loaded here -->
                <div class="doc-preview-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading documents...</p>
                </div>
            </div>
        </aside>
        
        <!-- Document Preview Area -->
        <section class="doc-preview-area">
            <div class="doc-preview-header">
                <div class="doc-preview-title">
                    <h2 id="currentDocName">Select a Document</h2>
                    <span class="doc-verified-badge" id="verifiedBadge" style="display: none;">
                        <i class="fas fa-check-circle"></i> Verified
                    </span>
                </div>
                <div class="doc-preview-actions">
                    <button class="preview-action-btn" onclick="zoomIn()" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="preview-action-btn" onclick="zoomOut()" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="preview-action-btn" onclick="openFullscreen()" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            
            <div class="doc-preview-frame" id="docPreviewFrame">
                <div class="doc-preview-placeholder">
                    <i class="fas fa-file-alt"></i>
                    <p>Select a document to preview</p>
                    <small>Click on any document from the list</small>
                </div>
            </div>
            
            <div class="doc-info-panel" id="docInfoPanel" style="display: none;">
                <div class="doc-info-grid">
                    <div class="doc-info-item">
                        <span class="doc-info-label">Document Type</span>
                        <span class="doc-info-value" id="infoDocType">-</span>
                    </div>
                    <div class="doc-info-item">
                        <span class="doc-info-label">Upload Date</span>
                        <span class="doc-info-value" id="infoUploadDate">-</span>
                    </div>
                    <div class="doc-info-item">
                        <span class="doc-info-label">File Size</span>
                        <span class="doc-info-value" id="infoFileSize">-</span>
                    </div>
                    <div class="doc-info-item">
                        <span class="doc-info-label">IPFS CID</span>
                        <span class="doc-info-value" id="infoIpfsCid" style="font-family: monospace; font-size: 0.8rem;">-</span>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script src="js/auth-utils.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/mobile-nav.js"></script>
    <script>
        // State
        let documents = [];
        let currentDocument = null;
        let currentZoom = 100;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Auth check
            if (typeof AuthUtils !== 'undefined') {
                const user = AuthUtils.getCurrentUser();
                if (!user) {
                    window.location.href = 'login-signup.html';
                    return;
                }
            }
            
            // Load documents based on URL params
            loadDocuments();
        });
        
        async function loadDocuments() {
            const params = new URLSearchParams(window.location.search);
            const documentId = params.get('documentId');
            const vin = params.get('vin');
            const vehicleId = params.get('vehicleId');
            const appId = params.get('appId');
            const cid = params.get('cid');
            
            const token = localStorage.getItem('token') || localStorage.getItem('authToken');
            
            try {
                // Case 0: Single document by IPFS CID (no metadata, just the file)
                if (cid) {
                    console.log('Loading single document by CID:', cid);
                    documents = [{
                        id: cid,
                        type: 'other',
                        label: 'Document',
                        filename: 'Document',
                        url: `/api/documents/ipfs/${cid}`,
                        cid: cid,
                        uploadDate: null,
                        verified: false
                    }];
                }
                
                // Case 1: Single document by ID
                if (!documents.length && documentId) {
                    console.log('Loading single document by ID:', documentId);
                    try {
                        const response = await fetch(`/api/documents/${documentId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.document) {
                                const doc = data.document;
                                documents = [{
                                    id: doc.id,
                                    type: doc.document_type || 'other',
                                    label: doc.original_name || doc.filename || 'Document',
                                    filename: doc.original_name || doc.filename,
                                    url: `/api/documents/${doc.id}/view`,
                                    cid: doc.ipfs_cid,
                                    uploadDate: doc.created_at,
                                    verified: true
                                }];
                                
                                // Try to get vehicle info
                                if (doc.vehicle_id) {
                                    try {
                                        const vehResponse = await fetch(`/api/vehicles/${doc.vehicle_id}`, {
                                            headers: { 'Authorization': `Bearer ${token}` }
                                        });
                                        if (vehResponse.ok) {
                                            const vehData = await vehResponse.json();
                                            if (vehData.vehicle) {
                                                document.getElementById('vehicleInfo').textContent = 
                                                    `${vehData.vehicle.make || ''} ${vehData.vehicle.model || ''} ${vehData.vehicle.year || ''} • ${vehData.vehicle.plate_number || ''}`;
                                            }
                                        }
                                    } catch (e) {
                                        console.log('Could not load vehicle info');
                                    }
                                }
                            }
                        } else {
                            throw new Error(`Document not found (${response.status})`);
                        }
                    } catch (apiError) {
                        console.error('Error loading document:', apiError);
                        showEmptyState('Document not found or access denied');
                        return;
                    }
                }
                
                // Case 2: Load documents by vehicle ID or VIN
                if (documents.length === 0 && (vin || vehicleId)) {
                    console.log('Loading documents by vehicle:', vehicleId || vin);
                    let url = vehicleId ? `/api/documents/vehicle-id/${vehicleId}` : `/api/documents/vehicle/${vin}`;
                    
                    try {
                        const response = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const rawDocs = data.documents || data.data || [];
                            
                            // Map to standard format
                            documents = rawDocs.map(doc => ({
                                id: doc.id,
                                type: getDocTypeCategory(doc.document_type),
                                label: getDocTypeLabel(doc.document_type) || doc.original_name || doc.filename || 'Document',
                                filename: doc.original_name || doc.filename,
                                url: `/api/documents/${doc.id}/view`,
                                cid: doc.ipfs_cid,
                                uploadDate: doc.created_at,
                                verified: true
                            }));
                            
                            // Update vehicle info
                            if (data.vehicle) {
                                document.getElementById('vehicleInfo').textContent = 
                                    `${data.vehicle.make || ''} ${data.vehicle.model || ''} ${data.vehicle.year || ''} • ${data.vehicle.plate_number || vin}`;
                            }
                        }
                    } catch (apiError) {
                        console.error('Error loading vehicle documents:', apiError);
                    }
                }
                
                // Case 3: Load documents by application ID (which is usually a vehicle ID)
                if (documents.length === 0 && appId) {
                    console.log('Loading documents by application ID:', appId);
                    try {
                        // Application ID is typically the vehicle ID in this system
                        const response = await fetch(`/api/documents/vehicle-id/${appId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const rawDocs = data.documents || data.data || [];
                            
                            documents = rawDocs.map(doc => ({
                                id: doc.id,
                                type: getDocTypeCategory(doc.document_type),
                                label: getDocTypeLabel(doc.document_type) || doc.original_name || 'Document',
                                filename: doc.original_name || doc.filename,
                                url: `/api/documents/${doc.id}/view`,
                                cid: doc.ipfs_cid,
                                uploadDate: doc.created_at,
                                verified: true
                            }));
                            
                            if (data.vehicle) {
                                document.getElementById('vehicleInfo').textContent = 
                                    `${data.vehicle.make || ''} ${data.vehicle.model || ''} • ${data.vehicle.plate_number || ''}`;
                            }
                        }
                    } catch (apiError) {
                        console.error('Error loading application documents:', apiError);
                    }
                }
                
                // If still no documents, show error
                if (documents.length === 0) {
                    console.log('No documents found');
                    showEmptyState('No documents found. Please ensure documents were uploaded properly.');
                    return;
                }
                
                renderDocumentList();
                
                // Auto-select first document
                if (documents.length > 0) {
                    selectDocument(0);
                }
                
            } catch (error) {
                console.error('Error loading documents:', error);
                showEmptyState();
            }
        }
        
        function renderDocumentList() {
            const container = document.getElementById('docListItems');
            const countBadge = document.getElementById('docCount');
            
            countBadge.textContent = documents.length;
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.4);">
                        <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>No documents found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = documents.map((doc, index) => `
                <div class="doc-list-item ${index === 0 ? 'active' : ''}" onclick="selectDocument(${index})" data-index="${index}">
                    <div class="doc-list-icon ${doc.type || 'other'}">
                        <i class="fas ${getDocIcon(doc.type)}"></i>
                    </div>
                    <div class="doc-list-info">
                        <div class="doc-list-name">${doc.label || doc.filename || doc.document_type || 'Document'}</div>
                        <div class="doc-list-meta">${doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString() : ''}</div>
                    </div>
                    <div class="doc-list-status ${doc.verified ? 'verified' : 'pending'}"></div>
                </div>
            `).join('');
        }
        
        function getDocIcon(type) {
            const icons = {
                registration: 'fa-car',
                insurance: 'fa-shield-alt',
                emission: 'fa-leaf',
                id: 'fa-id-card',
                other: 'fa-file-alt'
            };
            return icons[type] || 'fa-file-alt';
        }
        
        async function selectDocument(index) {
            // Update active state
            document.querySelectorAll('.doc-list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            currentDocument = documents[index];
            
            // Update header
            document.getElementById('currentDocName').textContent = currentDocument.label || currentDocument.filename || 'Document';
            
            // Show/hide verified badge
            const badge = document.getElementById('verifiedBadge');
            badge.style.display = currentDocument.verified ? 'inline-flex' : 'none';
            
            // Show info panel
            document.getElementById('docInfoPanel').style.display = 'block';
            document.getElementById('infoDocType').textContent = currentDocument.label || currentDocument.document_type || '-';
            document.getElementById('infoUploadDate').textContent = currentDocument.uploadDate ? new Date(currentDocument.uploadDate).toLocaleString() : '-';
            document.getElementById('infoFileSize').textContent = currentDocument.file_size ? formatFileSize(currentDocument.file_size) : '-';
            document.getElementById('infoIpfsCid').textContent = currentDocument.ipfs_cid || currentDocument.cid || '-';
            
            // Load preview
            await loadDocumentPreview(currentDocument);
        }
        
        async function loadDocumentPreview(doc) {
            const frame = document.getElementById('docPreviewFrame');
            
            // Debug: Log the document object
            console.log('Loading document:', doc);
            
            // Show loading
            frame.innerHTML = `
                <div class="doc-preview-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading document...</p>
                </div>
            `;
            
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                
                // Build URL from various sources
                let url = doc.url || doc.file_path || doc.path || doc.src || null;
                
                // If we have an ID that looks like a UUID (not local ID), use API
                if (!url && doc.id && typeof doc.id === 'string') {
                    const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(doc.id);
                    if (isUUID) {
                        url = `/api/documents/${doc.id}/view`;
                        console.log('Using API URL from UUID:', url);
                    }
                }
                
                // If we have a CID but no URL, use IPFS endpoint
                if (!url && (doc.cid || doc.ipfs_cid)) {
                    const cid = doc.cid || doc.ipfs_cid;
                    url = `/api/documents/ipfs/${cid}`;
                    console.log('Using IPFS URL:', url);
                }
                
                console.log('Final URL:', url ? (url.length > 100 ? url.substring(0, 100) + '...' : url) : 'null');
                
                if (!url) {
                    throw new Error('No document URL available. Document may not have been uploaded properly.');
                }
                
                // Check if the URL is a data URL (base64)
                const isDataUrl = typeof url === 'string' && url.startsWith('data:');
                
                // Check if image based on URL pattern, data URL type, or filename
                const urlStr = url || '';
                const filenameStr = doc.filename || doc.label || '';
                const isDataImage = isDataUrl && urlStr.startsWith('data:image');
                const isFileImage = /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(urlStr) || 
                                   /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(filenameStr);
                const isMimeImage = doc.mime_type && doc.mime_type.startsWith('image/');
                const isImage = isDataImage || isFileImage || isMimeImage;
                
                // Handle data URLs directly (base64 encoded)
                if (isDataUrl) {
                    console.log('Rendering data URL (base64)');
                    if (isImage) {
                        frame.innerHTML = `<img src="${url}" alt="${doc.label || 'Document'}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                    } else {
                        frame.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                    }
                }
                // Handle API endpoints
                else if (url.startsWith('/api/') || url.startsWith('/uploads/')) {
                    console.log('Fetching from server:', url);
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'image/*,application/pdf,*/*'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    console.log('Blob type:', blob.type, 'Size:', blob.size);
                    
                    if (isImage || blob.type.startsWith('image/')) {
                        frame.innerHTML = `<img src="${blobUrl}" alt="${doc.label || 'Document'}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                    } else {
                        frame.innerHTML = `<iframe src="${blobUrl}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                    }
                }
                // Handle regular URLs (http/https)
                else {
                    console.log('Using direct URL');
                    if (isImage) {
                        frame.innerHTML = `<img src="${url}" alt="${doc.label || 'Document'}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'doc-preview-placeholder\\' style=\\'color: #e74c3c;\\'><i class=\\'fas fa-exclamation-triangle\\'></i><p>Image failed to load</p></div>';">`;
                    } else {
                        frame.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                    }
                }
                
            } catch (error) {
                console.error('Error loading preview:', error);
                console.error('Document details:', {
                    id: doc.id,
                    url: doc.url ? (doc.url.length > 50 ? doc.url.substring(0, 50) + '...' : doc.url) : null,
                    cid: doc.cid,
                    label: doc.label
                });
                frame.innerHTML = `
                    <div class="doc-preview-placeholder" style="color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load document</p>
                        <small>${error.message}</small>
                        <div style="margin-top: 1rem;">
                            <small style="color: rgba(255,255,255,0.5);">Document ID: ${doc.id || 'N/A'}</small>
                        </div>
                    </div>
                `;
            }
        }
        
        function filterDocuments(query) {
            const items = document.querySelectorAll('.doc-list-item');
            const lowerQuery = query.toLowerCase();
            
            items.forEach((item, index) => {
                const doc = documents[index];
                const name = (doc.label || doc.filename || '').toLowerCase();
                const type = (doc.type || '').toLowerCase();
                
                const matches = name.includes(lowerQuery) || type.includes(lowerQuery);
                item.style.display = matches ? 'flex' : 'none';
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '-';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }
        
        function goBack() {
            if (document.referrer) {
                window.history.back();
            } else {
                // Determine where to go based on user role
                const user = AuthUtils?.getCurrentUser();
                if (user?.role === 'admin') {
                    window.location.href = 'admin-dashboard.html';
                } else {
                    window.location.href = 'owner-dashboard.html';
                }
            }
        }
        
        function downloadCurrentDocument() {
            if (!currentDocument) {
                alert('Please select a document first');
                return;
            }
            
            const url = currentDocument.url || currentDocument.file_path;
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = currentDocument.filename || 'document';
                a.click();
            }
        }
        
        function printDocument() {
            window.print();
        }
        
        function verifyOnBlockchain() {
            if (!currentDocument) {
                alert('Please select a document first');
                return;
            }
            
            const cid = currentDocument.ipfs_cid || currentDocument.cid;
            if (cid) {
                alert(`Document CID: ${cid}\n\nThis document is stored on IPFS and can be verified on the blockchain.`);
            } else {
                alert('This document does not have a blockchain reference yet.');
            }
        }
        
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 20, 200);
            applyZoom();
        }
        
        function zoomOut() {
            currentZoom = Math.max(currentZoom - 20, 50);
            applyZoom();
        }
        
        function applyZoom() {
            const frame = document.getElementById('docPreviewFrame');
            const content = frame.querySelector('iframe, img');
            if (content) {
                content.style.transform = `scale(${currentZoom / 100})`;
            }
        }
        
        function openFullscreen() {
            const frame = document.getElementById('docPreviewFrame');
            if (frame.requestFullscreen) {
                frame.requestFullscreen();
            }
        }
        
        function showEmptyState(message) {
            const main = document.getElementById('viewerMain');
            main.innerHTML = `
                <div class="empty-doc-state">
                    <i class="fas fa-folder-open"></i>
                    <h2>No Documents Found</h2>
                    <p>${message || 'There are no documents available to view.'}</p>
                    <button class="btn-primary" onclick="goBack()" style="margin-top: 1rem;">
                        <i class="fas fa-arrow-left"></i> Go Back
                    </button>
                </div>
            `;
        }
        
        // Helper function to get document type category for styling
        function getDocTypeCategory(docType) {
            const categories = {
                'registration_cert': 'registration',
                'registrationCert': 'registration',
                'or_cr': 'registration',
                'insurance_cert': 'insurance',
                'insuranceCert': 'insurance',
                'emission_cert': 'emission',
                'emissionCert': 'emission',
                'owner_id': 'id',
                'ownerId': 'id',
                'valid_id': 'id',
                'validId': 'id',
                'deed_of_sale': 'other',
                'deedOfSale': 'other'
            };
            return categories[docType] || 'other';
        }
        
        // Helper function to get human-readable document type label
        function getDocTypeLabel(docType) {
            const labels = {
                'registration_cert': 'Registration Certificate (OR/CR)',
                'registrationCert': 'Registration Certificate (OR/CR)',
                'or_cr': 'OR/CR',
                'insurance_cert': 'Insurance Certificate',
                'insuranceCert': 'Insurance Certificate',
                'emission_cert': 'Emission Certificate',
                'emissionCert': 'Emission Certificate',
                'owner_id': 'Owner ID',
                'ownerId': 'Owner ID',
                'valid_id': 'Valid ID',
                'validId': 'Valid ID',
                'deed_of_sale': 'Deed of Sale',
                'deedOfSale': 'Deed of Sale',
                'hpg_clearance': 'HPG Clearance',
                'hpgClearance': 'HPG Clearance'
            };
            return labels[docType] || docType;
        }
    </script>
</body>
</html>
