<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer of Ownership - LTO Management System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Transfer Upload Section - Using same structure as registration-wizard.html */
        .transfer-upload-section {
            margin-bottom: 2rem;
        }
        .transfer-upload-section h3 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .transfer-upload-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
            background: #fff;
        }
        .transfer-upload-item:hover {
            border-color: #3498db;
        }
        .transfer-upload-item.uploaded {
            border-color: #27ae60;
            background: #f0fff4;
        }
        .transfer-upload-info h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        .transfer-upload-info p {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 0;
        }
        .transfer-upload-area {
            position: relative;
            min-width: 150px;
        }
        .transfer-upload-area input[type="file"] {
            display: none;
        }
        .transfer-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .transfer-upload-label:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }
        .transfer-upload-label.uploaded {
            border-color: #27ae60;
            border-style: solid;
            background: #d4edda;
        }
        .transfer-upload-icon {
            font-size: 1.5rem;
        }
        .transfer-upload-text {
            font-size: 0.9rem;
            color: #555;
        }
        .transfer-file-name {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #27ae60;
            font-weight: bold;
        }
        
        /* OR/CR Number readonly styling */
        #toOrNumber[readonly], #toCrNumber[readonly] {
            background-color: #f0f8ff;
            border-color: #3498db;
            cursor: not-allowed;
        }
        
        #toOrNumber[readonly]:focus, #toCrNumber[readonly]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* OR/CR info badge */
        .orcr-info-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            font-size: 0.75rem;
            background: #d4edda;
            color: #155724;
            border-radius: 12px;
            font-weight: normal;
        }
        
        .orcr-info-badge i {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="logo" id="logoToggle" role="button" aria-label="Toggle sidebar" tabindex="0">
                    <img src="Logo/Land_Transportation_Office.svg.png" alt="LTO Logo" class="logo-image">
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="owner-dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="registration-wizard.html" class="nav-item">
                    <i class="fas fa-car"></i>
                    <span>New Registration</span>
                </a>
                <a href="transfer-ownership.html" class="nav-item active">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transfer of Ownership</span>
                </a>
                <a href="my-vehicle-ownership.html" class="nav-item">
                    <i class="fas fa-car"></i>
                    <span>My Vehicles</span>
                </a>
                <a href="#applications" class="nav-item">
                    <i class="fas fa-list"></i>
                    <span>My Applications</span>
                </a>
                <a href="#notifications" class="nav-item">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </a>
            </nav>
            
            <!-- Sidebar Footer with User Info -->
            <div class="sidebar-footer">
                <a href="settings.html" class="sidebar-user-profile">
                    <div class="sidebar-user-avatar" id="sidebarUserAvatar">GU</div>
                    <div class="sidebar-user-details">
                        <span class="sidebar-user-name" id="sidebarUserName">Loading...</span>
                        <span class="sidebar-user-role" id="sidebarUserRole">Loading...</span>
                    </div>
                </a>
                <div class="sidebar-user-actions">
                    <a href="#" class="sidebar-action-item" id="sidebarLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="dashboard-main">
            <header class="dashboard-header">
                <div class="container">
                    <div class="dashboard-nav">
                        <div class="nav-left">
                            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                                <i class="fas fa-bars"></i>
                            </button>
                            <div class="logo">
                                <h1>LTO MANAGEMENT SYSTEM</h1>
                            </div>
                        </div>
                        <div class="nav-right">
                            <button class="header-profile-btn" id="headerProfileBtn" aria-label="Profile">
                                <i class="fas fa-user-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="dashboard-content">
                <div class="container">
                    <!-- Progress Tracker -->
                    <div class="wizard-progress transfer-progress">
                        <div class="progress-step active" data-step="1">
                            <div class="step-number"><i class="fas fa-user-shield"></i></div>
                            <div class="step-label">Seller Info</div>
                        </div>
                        <div class="progress-step" data-step="2">
                            <div class="step-number"><i class="fas fa-user-plus"></i></div>
                            <div class="step-label">Buyer Info</div>
                        </div>
                        <div class="progress-step" data-step="3">
                            <div class="step-number"><i class="fas fa-car-side"></i></div>
                            <div class="step-label">Vehicle Info</div>
                        </div>
                        <div class="progress-step" data-step="4">
                            <div class="step-number"><i class="fas fa-file-upload"></i></div>
                            <div class="step-label">Upload Docs</div>
                        </div>
                        <div class="progress-step" data-step="5">
                            <div class="step-number"><i class="fas fa-check-circle"></i></div>
                            <div class="step-label">Submit</div>
                        </div>
                    </div>

                    <!-- Wizard Steps -->
                    <div class="wizard-steps">
                        <!-- Step 1 -->
                        <section id="to-step-1" class="wizard-step active">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-user-shield"></i></div>
                                        <div>
                                            <h2>Seller Information</h2>
                                            <p>Pre-filled from your profile; update contact and address if needed.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError" class="wizard-error"></div>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Seller Full Name</label>
                                            <input type="text" id="sellerName" placeholder="Auto-filled from profile">
                                        </div>
                                        <div class="form-group">
                                            <label>Seller Address</label>
                                            <input type="text" id="sellerAddress" placeholder="Street, City, Province">
                                        </div>
                                        <div class="form-group">
                                            <label>Seller Contact Number</label>
                                            <input type="tel" id="sellerContact" placeholder="+63 912 345 6789">
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-primary" onclick="toNextStep(2)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 2 -->
                        <section id="to-step-2" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-user-plus"></i></div>
                                        <div>
                                            <h2>Buyer Information</h2>
                                            <p>Collect buyer contact details.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError2" class="wizard-error"></div>
                                    <div class="form-grid">
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label>Buyer Email <span class="required">*</span></label>
                                            <input type="email" id="buyerEmail" placeholder="buyer@email.com" required>
                                            <small class="form-text text-muted">Enter the email address of the buyer. They will receive a notification to accept or reject the transfer request.</small>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(1)">Previous</button>
                                        <button class="btn-primary" onclick="toNextStep(3)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 3 -->
                        <section id="to-step-3" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-car-side"></i></div>
                                        <div>
                                            <h2>Vehicle Information</h2>
                                            <p>Identify the vehicle being transferred.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError3" class="wizard-error"></div>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Plate Number</label>
                                            <input type="text" id="toPlateNumber" placeholder="ABC-1234">
                                        </div>
                                        <div class="form-group">
                                            <label>Engine Number</label>
                                            <input type="text" id="toEngineNumber" placeholder="e.g., 2NR-FE123456">
                                        </div>
                                        <div class="form-group">
                                            <label>Chassis Number</label>
                                            <input type="text" id="toChassisNumber" placeholder="e.g., JT1234567890">
                                        </div>
                                        <div class="form-group">
                                            <label>Vehicle Type</label>
                                            <select id="toVehicleType">
                                                <option value="">Select Type</option>
                                                <option>Passenger Car</option>
                                                <option>Motorcycle</option>
                                                <option>Utility Vehicle</option>
                                                <option>Truck</option>
                                                <option>Bus</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                OR Number 
                                                <span class="orcr-info-badge" id="orBadge" style="display: none;">
                                                    <i class="fas fa-lock"></i> System Assigned
                                                </span>
                                            </label>
                                            <input type="text" id="toOrNumber" placeholder="e.g., OR-2025-000001" readonly>
                                            <small class="form-text text-muted" id="orHelpText">
                                                This will be auto-filled when you select a registered vehicle.
                                            </small>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                CR Number 
                                                <span class="orcr-info-badge" id="crBadge" style="display: none;">
                                                    <i class="fas fa-lock"></i> System Assigned
                                                </span>
                                            </label>
                                            <input type="text" id="toCrNumber" placeholder="e.g., CR-2025-000001" readonly>
                                            <small class="form-text text-muted" id="crHelpText">
                                                This will be auto-filled when you select a registered vehicle.
                                            </small>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(2)">Previous</button>
                                        <button class="btn-primary" onclick="toNextStep(4)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 4: Document Upload (Same structure as registration-wizard.html) -->
                        <section id="to-step-4" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-file-upload"></i></div>
                                        <div>
                                            <h2>Upload Required Documents</h2>
                                            <p>Upload the required documents. PDFs, JPG, PNG are accepted (max 10MB each).</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="wizardError4" class="wizard-error"></div>
                                    
                                    <!-- DEBUG: Test button to verify file input works -->
                                    <div style="background: #fff3cd; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ffc107;">
                                        <strong>üîß Debug Test:</strong> 
                                        <button type="button" onclick="testFileInput()" style="margin-left: 10px; padding: 5px 15px; cursor: pointer;">
                                            Test File Dialog
                                        </button>
                                        <span id="debug-result" style="margin-left: 10px;"></span>
                                    </div>
                                    
                                    <div class="transfer-upload-section">
                                        <h3>Required Documents</h3>
                                        
                                        <!-- Deed of Sale -->
                                        <div class="transfer-upload-item" id="upload-item-deedOfSale">
                                            <div class="transfer-upload-info">
                                                <h4>üìù Deed of Sale <span style="color: #e74c3c;">*</span></h4>
                                                <p>Notarized deed of sale document</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="deedOfSale" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'deedOfSale')">
                                                <label for="deedOfSale" class="transfer-upload-label" id="label-deedOfSale">
                                                    <span class="transfer-upload-icon">üìÑ</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-deedOfSale"></div>
                                            </div>
                                        </div>

                                        <!-- Seller Valid ID -->
                                        <div class="transfer-upload-item" id="upload-item-sellerId">
                                            <div class="transfer-upload-info">
                                                <h4>ü™™ Seller Valid ID <span style="color: #e74c3c;">*</span></h4>
                                                <p>Government-issued ID of the seller</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="sellerId" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'sellerId')">
                                                <label for="sellerId" class="transfer-upload-label" id="label-sellerId">
                                                    <span class="transfer-upload-icon">üÜî</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-sellerId"></div>
                                            </div>
                                        </div>

                                        <!-- Buyer Valid ID -->
                                        <div class="transfer-upload-item" id="upload-item-buyerId">
                                            <div class="transfer-upload-info">
                                                <h4>ü™™ Buyer Valid ID <span style="color: #e74c3c;">*</span></h4>
                                                <p>Government-issued ID of the buyer</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="buyerId" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'buyerId')">
                                                <label for="buyerId" class="transfer-upload-label" id="label-buyerId">
                                                    <span class="transfer-upload-icon">üÜî</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-buyerId"></div>
                                            </div>
                                        </div>

                                        <!-- OR/CR -->
                                        <div class="transfer-upload-item" id="upload-item-orCr">
                                            <div class="transfer-upload-info">
                                                <h4>üìã Latest OR/CR <span style="color: #e74c3c;">*</span></h4>
                                                <p>Official Receipt / Certificate of Registration</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="orCr" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'orCr')">
                                                <label for="orCr" class="transfer-upload-label" id="label-orCr">
                                                    <span class="transfer-upload-icon">üìÑ</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-orCr"></div>
                                            </div>
                                        </div>

                                        <!-- Emission Certificate (Optional) -->
                                        <div class="transfer-upload-item" id="upload-item-emissionCert">
                                            <div class="transfer-upload-info">
                                                <h4>üå± Emission Test Certificate <span style="color: #7f8c8d;">(Optional)</span></h4>
                                                <p>If available, upload emission test certificate</p>
                                            </div>
                                            <div class="transfer-upload-area">
                                                <input type="file" id="emissionCert" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTransferUpload(this, 'emissionCert')">
                                                <label for="emissionCert" class="transfer-upload-label" id="label-emissionCert">
                                                    <span class="transfer-upload-icon">üìÑ</span>
                                                    <span class="transfer-upload-text">Choose File</span>
                                                </label>
                                                <div class="transfer-file-name" id="filename-emissionCert"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(3)">Previous</button>
                                        <button class="btn-primary" onclick="toNextStep(5)">Next</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Step 5: Review & Submit -->
                        <section id="to-step-5" class="wizard-step">
                            <div class="transfer-card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-icon"><i class="fas fa-clipboard-check"></i></div>
                                        <div>
                                            <h2>Review & Submit</h2>
                                            <p>Confirm all details before submission.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="summary-grid">
                                        <div class="summary-card">
                                            <h4><i class="fas fa-user-shield"></i> Seller Details</h4>
                                            <ul>
                                                <li><strong>Name:</strong> <span id="summarySellerName">Auto-filled</span></li>
                                                <li><strong>Address:</strong> <span id="summarySellerAddress">‚Äî</span></li>
                                                <li><strong>Contact:</strong> <span id="summarySellerContact">‚Äî</span></li>
                                            </ul>
                                        </div>
                                        <div class="summary-card">
                                            <h4><i class="fas fa-user-plus"></i> Buyer Details</h4>
                                            <ul>
                                                <li><strong>Email:</strong> <span id="summaryBuyerEmail">‚Äî</span></li>
                                            </ul>
                                        </div>
                                        <div class="summary-card">
                                            <h4><i class="fas fa-car"></i> Vehicle Details</h4>
                                            <ul>
                                                <li><strong>Plate No.:</strong> <span id="summaryPlate">‚Äî</span></li>
                                                <li><strong>Engine No.:</strong> <span id="summaryEngine">‚Äî</span></li>
                                                <li><strong>Chassis No.:</strong> <span id="summaryChassis">‚Äî</span></li>
                                                <li><strong>Type:</strong> <span id="summaryType">‚Äî</span></li>
                                                <li><strong>OR No.:</strong> <span id="summaryOr">‚Äî</span></li>
                                                <li><strong>CR No.:</strong> <span id="summaryCr">‚Äî</span></li>
                                            </ul>
                                        </div>
                                        <div class="summary-card">
                                            <h4><i class="fas fa-file-alt"></i> Uploaded Documents</h4>
                                            <ul id="summaryUploads">
                                                <li>Deed of Sale</li>
                                                <li>Seller Valid ID</li>
                                                <li>Buyer Valid ID</li>
                                                <li>Latest OR/CR</li>
                                                <li>Optional: Emission Test Certificate</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="wizard-actions">
                                        <button class="btn-secondary" onclick="toPrevStep(4)">Previous</button>
                                        <button class="btn-primary" onclick="submitTransfer()">Submit Request</button>
                                        <button class="btn-secondary" onclick="cancelTransfer()">Cancel</button>
                                    </div>
                                    <div class="confirmation-message" id="confirmationMessage" style="display:none;">
                                        <i class="fas fa-check-circle"></i>
                                        <div>
                                            <h4>Request Submitted</h4>
                                            <p>Your Transfer of Ownership request has been successfully sent to LTO for review.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script src="js/auth-utils.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/mobile-nav.js"></script>
    <script src="js/document-upload-utils.js"></script>
    <script>
        // DEBUG: Log immediately when script loads
        console.log('üöÄ transfer-ownership.html script starting...');

        // Transfer data storage
        let transferData = {
            seller: {},
            buyer: {},
            vehicle: null,
            vehicleId: null,
            documents: {}
        };
        let userVehicles = [];
        let currentToStep = 1;
        // Note: apiClient is already declared globally in api-client.js

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ DOMContentLoaded fired');
            
            // ===== AUTHENTICATION CHECK - MUST BE FIRST =====
            if (typeof AuthUtils !== 'undefined') {
                const user = AuthUtils.getCurrentUser();
                if (!user) {
                    console.log('‚ùå Not authenticated, redirecting to login...');
                    window.location.href = 'login-signup.html';
                    return;
                }
                console.log('‚úÖ User authenticated:', user.email);
            } else {
                console.error('‚ùå AuthUtils not loaded');
                window.location.href = 'login-signup.html';
                return;
            }
            // ================================================
            
            try {
                // Use global apiClient from api-client.js (already loaded)
                console.log('‚úÖ Using global apiClient:', typeof window.apiClient);
            
            // Sidebar toggle and state
            const sidebar = document.querySelector('.dashboard-sidebar');
            const logoToggle = document.getElementById('logoToggle');

            const savedSidebarState = localStorage.getItem('ownerSidebarCollapsed');
            if (sidebar && savedSidebarState === 'true') {
                sidebar.classList.add('collapsed');
            }

            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                if (!sidebar) return;
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('ownerSidebarCollapsed', isCollapsed ? 'true' : 'false');
            }

            if (logoToggle && sidebar) {
                logoToggle.addEventListener('click', toggleSidebar);
                logoToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        toggleSidebar(e);
                    }
                });
            }

            // Update sidebar user info
            updateSidebarUserInfo();
            console.log('‚úÖ Sidebar user info updated');
            
            // Load seller info from profile
            await loadSellerInfo();
            console.log('‚úÖ Seller info loaded');
            
            // Load user's vehicles
            await loadUserVehicles();
            console.log('‚úÖ User vehicles loaded');
            
            // Initialize file upload handlers
            initializeFileUploads();
            console.log('‚úÖ All initialization complete');
            
            // Initialize mobile navigation
            initializeMobileNavigation();
            
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
            }
        });
        
        // Initialize mobile navigation
        function initializeMobileNavigation() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebar = document.querySelector('.dashboard-sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMobileSidebar();
                });
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    closeMobileSidebar();
                });
            }
            
            // Close sidebar when clicking on nav items
            const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeMobileSidebar();
                    }
                });
            });
        }
        
        // Toggle mobile sidebar
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.dashboard-sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggleBtn = document.getElementById('mobileMenuToggle');
            
            if (!sidebar) return;
            
            if (sidebar.classList.contains('mobile-open')) {
                closeMobileSidebar();
            } else {
                openMobileSidebar();
            }
        }
        
        // Open mobile sidebar
        function openMobileSidebar() {
            const sidebar = document.querySelector('.dashboard-sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggleBtn = document.getElementById('mobileMenuToggle');
            
            if (sidebar) {
                sidebar.classList.add('mobile-open');
                sidebar.classList.remove('collapsed');
            }
            
            if (overlay) {
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            if (toggleBtn) {
                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-times';
                }
            }
        }
        
        // Close mobile sidebar
        function closeMobileSidebar() {
            const sidebar = document.querySelector('.dashboard-sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggleBtn = document.getElementById('mobileMenuToggle');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            if (toggleBtn) {
                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-bars';
                }
            }
        }

        function updateSidebarUserInfo() {
            if (typeof AuthUtils !== 'undefined') {
                const user = AuthUtils.getCurrentUser();
                if (user) {
                    const sidebarUserNameEl = document.getElementById('sidebarUserName');
                    const sidebarUserRoleEl = document.getElementById('sidebarUserRole');
                    const sidebarUserAvatarEl = document.getElementById('sidebarUserAvatar');
                    
                    if (sidebarUserNameEl) sidebarUserNameEl.textContent = AuthUtils.getUserDisplayName();
                    if (sidebarUserRoleEl) sidebarUserRoleEl.textContent = 'Vehicle Owner';
                    if (sidebarUserAvatarEl) sidebarUserAvatarEl.textContent = AuthUtils.getUserInitials();
                } else {
                    window.location.href = 'login-signup.html';
                }
            }
            
            // Logout handler
            const logoutBtn = document.getElementById('sidebarLogoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof AuthUtils !== 'undefined') {
                        AuthUtils.logout();
                    }
                    window.location.href = 'login-signup.html';
                });
            }
        }

        async function loadSellerInfo() {
            try {
                // Fetch full profile from API to get phone and other details
                const profileResponse = await window.apiClient.get('/api/auth/profile');
                const user = profileResponse.success ? profileResponse.user : AuthUtils.getCurrentUser();
                
                if (user) {
                    const sellerNameEl = document.getElementById('sellerName');
                    const sellerAddressEl = document.getElementById('sellerAddress');
                    const sellerContactEl = document.getElementById('sellerContact');
                    
                    // Set seller name from profile (editable)
                    const displayName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                    if (sellerNameEl) {
                        sellerNameEl.value = displayName;
                        sellerNameEl.removeAttribute('disabled'); // Make editable
                    }
                    
                    // Auto-fill phone if available (editable)
                    if (sellerContactEl && user.phone) {
                        sellerContactEl.value = user.phone;
                    }
                    
                    // Address field remains empty for user to fill (not in user profile)
                    // User can edit all fields as needed
                    
                    // Store seller data
                    transferData.seller = {
                        id: user.id || user.userId,
                        name: displayName,
                        email: user.email,
                        phone: user.phone || ''
                    };
                }
            } catch (error) {
                console.error('Error loading seller info:', error);
                // Fallback to current user if API fails
                const user = AuthUtils.getCurrentUser();
                if (user) {
                    const sellerNameEl = document.getElementById('sellerName');
                    if (sellerNameEl) {
                        const displayName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                        sellerNameEl.value = displayName;
                        sellerNameEl.removeAttribute('disabled');
                    }
                }
            }
        }

        async function loadUserVehicles() {
            try {
                const response = await window.apiClient.get('/api/vehicles/my-vehicles');
                if (response.success && response.vehicles) {
                    // Include vehicles that are fully registered/approved
                    userVehicles = response.vehicles.filter(v => v.status === 'REGISTERED' || v.status === 'APPROVED');
                    populateVehicleSelector();
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        function populateVehicleSelector() {
            // Add vehicle selector to step 3
            const vehicleContainer = document.querySelector('#to-step-3 .form-grid');
            if (!vehicleContainer) return;
            
            // Check if selector already exists
            if (document.getElementById('vehicleSelector')) return;
            
            // Create vehicle selector
            const selectorHTML = `
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Select Your Vehicle</label>
                    <select id="vehicleSelector" onchange="selectVehicle(this.value)">
                        <option value="">-- Select a registered vehicle --</option>
                        ${userVehicles.map(v => `
                            <option value="${v.id}">
                                ${v.plate_number || v.plateNumber || 'N/A'} - ${v.make} ${v.model} ${v.year}
                            </option>
                        `).join('')}
                    </select>
                    ${userVehicles.length === 0 ? '<small style="color: #e74c3c;">No registered vehicles found. You can only transfer registered vehicles.</small>' : ''}
                </div>
            `;
            
            vehicleContainer.insertAdjacentHTML('afterbegin', selectorHTML);
            
            // Check if vehicle was pre-selected from vehicle list page
            const selectedVehicleId = sessionStorage.getItem('selectedVehicleId');
            if (selectedVehicleId) {
                const vehicle = userVehicles.find(v => v.id === selectedVehicleId);
                if (vehicle) {
                    // Auto-select the vehicle
                    const selector = document.getElementById('vehicleSelector');
                    if (selector) {
                        selector.value = selectedVehicleId;
                        selectVehicle(selectedVehicleId);
                        
                        // Show notification
                        if (typeof ToastNotification !== 'undefined') {
                            ToastNotification.show(`Vehicle ${vehicle.plate_number || vehicle.plateNumber || ''} pre-selected`, 'info');
                        }
                    }
                }
                // Clear sessionStorage
                sessionStorage.removeItem('selectedVehicleId');
                sessionStorage.removeItem('selectedVehiclePlate');
            }
        }

        function selectVehicle(vehicleId) {
            const vehicle = userVehicles.find(v => v.id === vehicleId);
            if (vehicle) {
                transferData.vehicleId = vehicleId;
                transferData.vehicle = vehicle;
                
                // Auto-fill vehicle fields
                document.getElementById('toPlateNumber').value = vehicle.plate_number || vehicle.plateNumber || '';
                document.getElementById('toEngineNumber').value = vehicle.engine_number || vehicle.engineNumber || '';
                document.getElementById('toChassisNumber').value = vehicle.chassis_number || vehicle.chassisNumber || vehicle.vin || '';
                document.getElementById('toVehicleType').value = vehicle.vehicle_type || vehicle.vehicleType || '';
                
                // Auto-fill separate OR and CR Numbers from vehicle record
                const orField = document.getElementById('toOrNumber');
                const crField = document.getElementById('toCrNumber');
                const orBadge = document.getElementById('orBadge');
                const crBadge = document.getElementById('crBadge');
                const orHelpText = document.getElementById('orHelpText');
                const crHelpText = document.getElementById('crHelpText');
                
                // Get separate OR and CR numbers (new format)
                const orNumber = vehicle.or_number || vehicle.orNumber || '';
                const crNumber = vehicle.cr_number || vehicle.crNumber || '';
                // Backward compatibility
                const orCrNumber = vehicle.or_cr_number || vehicle.orCrNumber || vehicle.orcr_number || '';
                
                if (orField) {
                    orField.value = orNumber || (orCrNumber ? orCrNumber.replace('ORCR-', 'OR-') : '');
                    if (orNumber || orCrNumber) {
                        orField.style.backgroundColor = '#f0f8ff';
                        if (orBadge) orBadge.style.display = 'inline-block';
                        if (orHelpText) orHelpText.style.display = 'none';
                    } else {
                        if (orBadge) orBadge.style.display = 'none';
                        if (orHelpText) {
                            orHelpText.style.display = 'block';
                            orHelpText.textContent = 'No OR number found for this vehicle.';
                        }
                    }
                }
                
                if (crField) {
                    crField.value = crNumber || (orCrNumber ? orCrNumber.replace('ORCR-', 'CR-') : '');
                    if (crNumber || orCrNumber) {
                        crField.style.backgroundColor = '#f0f8ff';
                        if (crBadge) crBadge.style.display = 'inline-block';
                        if (crHelpText) crHelpText.style.display = 'none';
                    } else {
                        if (crBadge) crBadge.style.display = 'none';
                        if (crHelpText) {
                            crHelpText.style.display = 'block';
                            crHelpText.textContent = 'No CR number found for this vehicle.';
                        }
                    }
                }
                
                // Make other fields readonly since they come from the system
                document.getElementById('toPlateNumber').readOnly = true;
                document.getElementById('toEngineNumber').readOnly = true;
                document.getElementById('toChassisNumber').readOnly = true;
                
                // Log for debugging
                console.log('‚úÖ Vehicle selected:', {
                    vehicleId,
                    plateNumber: vehicle.plate_number || vehicle.plateNumber,
                    orCrNumber: vehicle.or_cr_number || vehicle.orCrNumber || 'N/A'
                });
            }
        }

        function initializeFileUploads() {
            console.log('üîß Initializing file upload handlers...');
            
            // Add click listeners to debug and ensure they work
            const docTypes = ['deedOfSale', 'sellerId', 'buyerId', 'orCr', 'emissionCert'];
            
            docTypes.forEach(docType => {
                const input = document.getElementById(docType);
                const label = document.getElementById(`label-${docType}`);
                
                console.log(`üìÅ ${docType}: input found = ${!!input}, label found = ${!!label}`);
                
                if (input) {
                    console.log(`   Input ID: ${input.id}, type: ${input.type}, accept: ${input.accept}`);
                }
                
                if (label) {
                    console.log(`   Label for: ${label.getAttribute('for')}`);
                    
                    // WORKAROUND: Directly trigger file input on label click
                    label.addEventListener('click', function(e) {
                        console.log(`üëÜ Label clicked for: ${docType}`);
                        e.preventDefault(); // Prevent default label behavior
                        e.stopPropagation();
                        
                        // Programmatically click the file input
                        if (input) {
                            console.log(`üñ±Ô∏è Programmatically clicking input: ${docType}`);
                            input.click();
                        } else {
                            console.error(`‚ùå Input not found for: ${docType}`);
                        }
                    });
                }
                
                if (input) {
                    // Log when file input is clicked directly
                    input.addEventListener('click', function(e) {
                        console.log(`üñ±Ô∏è File input click event: ${docType}`);
                    });
                    
                    // Log when file dialog opens/closes
                    input.addEventListener('change', function(e) {
                        console.log(`üìÇ File input changed: ${docType}`, this.files);
                    });
                }
            });
            
            console.log('‚úÖ File upload handlers initialized');
        }

        // Handle file upload - using unified upload utility
        async function handleTransferUpload(input, docType) {
            console.log(`üì§ handleTransferUpload called for: ${docType}`);
            
            if (!input.files || input.files.length === 0) {
                console.log(`‚ö†Ô∏è No files selected for ${docType}`);
                return;
            }
            
            const file = input.files[0];
            const label = document.getElementById(`label-${docType}`);
            const filenameDiv = document.getElementById(`filename-${docType}`);
            const uploadItem = document.getElementById(`upload-item-${docType}`);
            
            // Map transfer-specific doc types to logical document types
            // Transfer uses specific roles, but we need to map to logical types for upload
            const docTypeMap = {
                'deedOfSale': DocumentUploadUtils.DOCUMENT_TYPES.DEED_OF_SALE,
                'sellerId': DocumentUploadUtils.DOCUMENT_TYPES.SELLER_ID,
                'buyerId': DocumentUploadUtils.DOCUMENT_TYPES.BUYER_ID,
                'orCr': DocumentUploadUtils.DOCUMENT_TYPES.REGISTRATION_CERT, // OR/CR is a registration cert
                'emissionCert': DocumentUploadUtils.DOCUMENT_TYPES.EMISSION_CERT
            };
            
            const logicalDocType = docTypeMap[docType] || DocumentUploadUtils.DOCUMENT_TYPES.OTHER;
            
            // Show uploading state
            if (label) {
                label.innerHTML = `
                    <span class="transfer-upload-icon">‚è≥</span>
                    <span class="transfer-upload-text">Uploading...</span>
                `;
            }
            
            try {
                // Use unified upload utility
                const result = await DocumentUploadUtils.uploadDocument(logicalDocType, file, {
                    vehicleId: transferData.vehicleId,
                    onProgress: (progress) => {
                        // Optional: Update progress indicator
                        console.log(`Upload progress for ${docType}:`, progress);
                    }
                });
                
                if (result.success) {
                    // Store document info with transfer role
                    transferData.documents[docType] = {
                        id: result.document?.id || result.document?.document?.id,
                        filename: result.document?.originalName || file.name,
                        cid: result.document?.cid || result.document?.ipfsHash
                    };
                    
                    // Update UI to show success
                    if (label) {
                        label.classList.add('uploaded');
                        label.innerHTML = `
                            <span class="transfer-upload-icon">‚úÖ</span>
                            <span class="transfer-upload-text">Uploaded</span>
                        `;
                    }
                    if (uploadItem) {
                        uploadItem.classList.add('uploaded');
                    }
                    if (filenameDiv) {
                        filenameDiv.textContent = file.name;
                    }
                    
                    showNotification(`${file.name} uploaded successfully`, 'success');
                    console.log(`‚úÖ Document uploaded successfully:`, {
                        docType,
                        logicalType: logicalDocType,
                        documentId: transferData.documents[docType].id
                    });
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                
                // Reset label on error
                if (label) {
                    label.classList.remove('uploaded');
                    label.innerHTML = `
                        <span class="transfer-upload-icon">üìÑ</span>
                        <span class="transfer-upload-text">Choose File</span>
                    `;
                }
                if (filenameDiv) {
                    filenameDiv.innerHTML = `<span style="color: #e74c3c;">‚ùå ${error.message || 'Upload failed'}</span>`;
                }
                
                showNotification(`Upload failed: ${error.message || 'Unknown error'}`, 'error');
            }
        }

        function showWizardError(step, message) {
            const idMap = {1:'wizardError',2:'wizardError2',3:'wizardError3',4:'wizardError4'};
            const errorEl = document.getElementById(idMap[step] || 'wizardError');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            }
        }

        function clearWizardErrors() {
            document.querySelectorAll('.wizard-error').forEach(el => {
                el.textContent = '';
                el.classList.remove('show');
            });
            document.querySelectorAll('.transfer-card input, .transfer-card select').forEach(el => {
                el.classList.remove('invalid');
            });
        }

        function validateToStep(step) {
            clearWizardErrors();
            let valid = true;
            const markInvalid = (el) => { if (el) el.classList.add('invalid'); valid = false; };

            if (step === 1) {
                const addr = document.getElementById('sellerAddress');
                const contact = document.getElementById('sellerContact');
                if (!addr?.value.trim()) markInvalid(addr);
                if (!contact?.value.trim()) markInvalid(contact);
                if (!valid) showWizardError(1, 'Please complete seller address and contact before continuing.');
                
                // Store seller data
                transferData.seller.address = addr?.value.trim();
                transferData.seller.phone = contact?.value.trim();
            } else if (step === 2) {
                // NEW: Only require buyer email (simplified workflow)
                const buyerEmail = document.getElementById('buyerEmail');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!buyerEmail?.value.trim() || !emailRegex.test(buyerEmail.value.trim())) {
                    markInvalid(buyerEmail);
                    valid = false;
                }
                
                // Prevent seller from transferring to themselves
                if (typeof AuthUtils !== 'undefined') {
                    const currentUser = AuthUtils.getCurrentUser();
                    const currentUserEmail = currentUser?.email;
                    if (currentUserEmail && buyerEmail?.value.trim().toLowerCase() === currentUserEmail.toLowerCase()) {
                        markInvalid(buyerEmail);
                        showWizardError(2, 'You cannot transfer ownership to yourself. Please enter a different email address.');
                        return;
                    }
                }
                
                if (!valid) {
                    showWizardError(2, 'Please enter a valid buyer email address.');
                    return;
                }
                
                // Store only email - buyer will complete profile when they accept
                transferData.buyer = {
                    email: buyerEmail.value.trim()
                };
            } else if (step === 3) {
                const vehicleSelector = document.getElementById('vehicleSelector');
                if (!vehicleSelector?.value) {
                    showWizardError(3, 'Please select a vehicle to transfer.');
                    valid = false;
                }
                
                const plate = document.getElementById('toPlateNumber');
                const engine = document.getElementById('toEngineNumber');
                const chassis = document.getElementById('toChassisNumber');
                const type = document.getElementById('toVehicleType');
                const orNumber = document.getElementById('toOrNumber');
                const crNumber = document.getElementById('toCrNumber');
                
                // Validate required fields
                if (!plate?.value.trim()) markInvalid(plate);
                if (!chassis?.value.trim()) markInvalid(chassis);
                if (!orcr?.value.trim()) markInvalid(orcr);  // ‚úÖ OR/CR validation added
                
                if (!valid) {
                    const missingFields = [];
                    if (!plate?.value.trim()) missingFields.push('Plate Number');
                    if (!chassis?.value.trim()) missingFields.push('Chassis Number');
                    if (!orcr?.value.trim()) missingFields.push('OR/CR Number');  // ‚úÖ Include in error message
                    showWizardError(3, `Please complete all required fields: ${missingFields.join(', ')}`);
                }
            } else if (step === 4) {
                // Check required documents
                const requiredDocs = ['deedOfSale', 'sellerId', 'buyerId', 'orCr'];
                // Enhanced validation: Check that documents exist AND have IDs
                const missingDocs = requiredDocs.filter(doc => {
                    const docData = transferData.documents[doc];
                    return !docData || !docData.id;
                });
                
                if (missingDocs.length > 0) {
                    const docNames = {
                        'deedOfSale': 'Deed of Sale',
                        'sellerId': 'Seller ID',
                        'buyerId': 'Buyer ID',
                        'orCr': 'OR/CR'
                    };
                    const missingNames = missingDocs.map(d => docNames[d] || d).join(', ');
                    showWizardError(4, `Please upload all required documents: ${missingNames}`);
                    valid = false;
                }
            }

            return valid;
        }

        function setToStep(targetStep) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.transfer-progress .progress-step').forEach(s => s.classList.remove('active'));
            const stepEl = document.getElementById(`to-step-${targetStep}`);
            const progressEl = document.querySelector(`.transfer-progress [data-step="${targetStep}"]`);
            if (stepEl) stepEl.classList.add('active');
            if (progressEl) progressEl.classList.add('active');
            currentToStep = targetStep;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update summary on step 5
            if (targetStep === 5) {
                updateSummary();
            }
        }

        function updateSummary() {
            // Seller
            document.getElementById('summarySellerName').textContent = transferData.seller.name || 'N/A';
            document.getElementById('summarySellerAddress').textContent = transferData.seller.address || 'N/A';
            document.getElementById('summarySellerContact').textContent = transferData.seller.phone || 'N/A';
            
            // Buyer (email only)
            document.getElementById('summaryBuyerEmail').textContent = transferData.buyer.email || 'N/A';
            
            // Vehicle
            const vehicle = transferData.vehicle;
            document.getElementById('summaryPlate').textContent = vehicle?.plate_number || vehicle?.plateNumber || 'N/A';
            document.getElementById('summaryEngine').textContent = vehicle?.engine_number || vehicle?.engineNumber || 'N/A';
            document.getElementById('summaryChassis').textContent = vehicle?.chassis_number || vehicle?.chassisNumber || vehicle?.vin || 'N/A';
            document.getElementById('summaryType').textContent = vehicle?.vehicle_type || vehicle?.vehicleType || 'N/A';
            
            // OR/CR Number - prefer vehicle object, fallback to field value
            const orCrNumber = vehicle?.or_cr_number || vehicle?.orCrNumber || document.getElementById('toOrCrNumber')?.value || 'N/A';
            document.getElementById('summaryOrCr').textContent = orCrNumber;
            
            // Documents
            const uploadsList = document.getElementById('summaryUploads');
            if (uploadsList) {
                const docNames = {
                    'deedOfSale': 'Deed of Sale',
                    'sellerId': 'Seller Valid ID',
                    'buyerId': 'Buyer Valid ID',
                    'orCr': 'Latest OR/CR',
                    'emissionCert': 'Emission Test Certificate'
                };
                uploadsList.innerHTML = Object.entries(transferData.documents)
                    .map(([type, doc]) => `<li>‚úÖ ${docNames[type] || type}: ${doc.filename}</li>`)
                    .join('') || '<li>No documents uploaded</li>';
            }
        }

        function toNextStep(targetStep) {
            const currentStep = targetStep - 1;
            if (!validateToStep(currentStep)) return;
            setToStep(targetStep);
        }

        function toPrevStep(targetStep) {
            setToStep(targetStep);
        }

        async function submitTransfer() {
            try {
                // Validate we have required data
                if (!transferData.vehicleId) {
                    showNotification('Please select a vehicle to transfer', 'error');
                    return;
                }
                
                if (!transferData.buyer.email) {
                    showNotification('Buyer information is incomplete', 'error');
                    return;
                }
                
                // Validate required documents are present
                const requiredDocs = ['deedOfSale', 'sellerId', 'buyerId', 'orCr'];
                const missingDocs = requiredDocs.filter(doc => !transferData.documents[doc] || !transferData.documents[doc].id);
                
                if (missingDocs.length > 0) {
                    const docNames = {
                        'deedOfSale': 'Deed of Sale',
                        'sellerId': 'Seller ID',
                        'buyerId': 'Buyer ID',
                        'orCr': 'OR/CR'
                    };
                    showNotification(`Please upload all required documents: ${missingDocs.map(d => docNames[d] || d).join(', ')}`, 'error');
                    return;
                }
                
                // Prepare request data with explicit document roles (NEW APPROACH - Option A: email-based)
                const requestData = {
                    vehicleId: transferData.vehicleId,
                    buyerEmail: transferData.buyer.email,
                    // NEW: Explicit document roles (preferred)
                    documents: {
                        deedOfSale: transferData.documents.deedOfSale?.id,
                        sellerId: transferData.documents.sellerId?.id,
                        buyerId: transferData.documents.buyerId?.id,
                        orCr: transferData.documents.orCr?.id
                    }
                    // LEGACY: Keep documentIds for backward compatibility (will be ignored if documents is provided)
                    // documentIds: Object.values(transferData.documents)
                    //     .filter(d => d.id)
                    //     .map(d => d.id)
                };
                
                console.log('üì§ Submitting transfer request with explicit document roles:', {
                    vehicleId: requestData.vehicleId,
                    documentCount: Object.keys(requestData.documents).length,
                    documents: requestData.documents
                });
                
                // Submit to API
                const response = await window.apiClient.post('/api/vehicles/transfer/requests', requestData);
                
                if (response.success) {
                    const confirmation = document.getElementById('confirmationMessage');
                    if (confirmation) {
                        confirmation.style.display = 'flex';
                        confirmation.innerHTML = `
                            <i class="fas fa-check-circle" style="color: #27ae60; font-size: 3rem;"></i>
                            <div>
                                <h4>Request Submitted Successfully!</h4>
                                <p>Your Transfer of Ownership request has been submitted for review.</p>
                                <p><strong>Request ID:</strong> ${response.transferRequest?.id?.substring(0, 8) || 'N/A'}</p>
                                <p>You will be notified when the request is processed.</p>
                                <button class="btn-primary" onclick="window.location.href='owner-dashboard.html'" style="margin-top: 15px;">
                                    Return to Dashboard
                                </button>
                            </div>
                        `;
                    }
                    
                    // Hide action buttons
                    const actions = document.querySelector('#to-step-5 .wizard-actions');
                    if (actions) actions.style.display = 'none';
                    
                    showNotification('Transfer request submitted successfully!', 'success');
                } else {
                    throw new Error(response.error || 'Failed to submit transfer request');
                }
            } catch (error) {
                console.error('Submit transfer error:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function cancelTransfer() {
            if (confirm('Are you sure you want to cancel? All entered data will be lost.')) {
                window.location.href = 'owner-dashboard.html';
            }
        }

        function showNotification(message, type = 'info') {
            if (typeof ToastNotification !== 'undefined') {
                ToastNotification.show(message, type);
            } else {
                alert(message);
            }
        }

        // DEBUG: Test function for file input
        function testFileInput() {
            console.log('üß™ Test button clicked');
            const resultSpan = document.getElementById('debug-result');
            
            // Create a temporary file input
            const testInput = document.createElement('input');
            testInput.type = 'file';
            testInput.accept = '.pdf,.jpg,.jpeg,.png';
            
            testInput.onchange = function() {
                console.log('üß™ Test file selected:', this.files[0]?.name);
                if (resultSpan) {
                    resultSpan.innerHTML = `<span style="color: green;">‚úÖ File selected: ${this.files[0]?.name}</span>`;
                }
            };
            
            console.log('üß™ Triggering test file input click...');
            testInput.click();
            
            if (resultSpan) {
                resultSpan.innerHTML = '<span style="color: blue;">File dialog should be open...</span>';
            }
        }

        // DEBUG: Also expose a manual trigger function
        function manualTrigger(docType) {
            console.log(`üîß Manual trigger for: ${docType}`);
            const input = document.getElementById(docType);
            if (input) {
                console.log(`   Found input, triggering click...`);
                input.click();
            } else {
                console.error(`   Input not found: ${docType}`);
            }
        }
    </script>
</body>
</html>
