# ðŸ” Auto-Verification Tables Inspection Guide

## Overview

This guide provides SQL queries to check all tables related to certificate auto-verification implementation.

---

## ðŸ“Š Key Tables for Auto-Verification

### 1. `issued_certificates` - Generated Certificates
Stores certificates generated by `certificate-generator.html`

### 2. `certificates` - Other Certificate Sources
Stores certificates from other sources (legacy/external)

### 3. `clearance_requests` - Verification Requests
Stores verification requests with auto-verification results in `metadata` JSONB

### 4. `vehicle_verifications` - Verification Status
Stores verification status and auto-verification metadata

### 5. `vehicles` - Vehicle Records
Vehicle data used for matching

### 6. `documents` - Document Files
Document files uploaded for verification

---

## ðŸ” Inspection Queries

### 1. Check `issued_certificates` Table Structure

```bash
docker exec postgres psql -U lto_user -d lto_blockchain -c "\d issued_certificates"
```

**Or detailed:**
```sql
SELECT 
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_name = 'issued_certificates'
ORDER BY ordinal_position;
```

### 2. View Generated Certificates

```sql
-- List all issued certificates
SELECT 
    id,
    certificate_type,
    vehicle_vin,
    certificate_number,
    file_hash,
    composite_hash,
    issued_at,
    expires_at,
    created_at
FROM issued_certificates
ORDER BY created_at DESC
LIMIT 20;
```

### 3. Check Certificate Metadata (JSONB)

```sql
-- View certificate metadata structure
SELECT 
    certificate_type,
    vehicle_vin,
    certificate_number,
    metadata->>'policyNumber' AS policy_number,
    metadata->>'clearanceNumber' AS clearance_number,
    metadata->>'engineNumber' AS engine_number,
    metadata->>'chassisNumber' AS chassis_number,
    jsonb_pretty(metadata) AS full_metadata
FROM issued_certificates
WHERE certificate_type IN ('insurance', 'emission', 'hpg_clearance')
ORDER BY created_at DESC
LIMIT 10;
```

### 4. Check `clearance_requests` Auto-Verification Results

```sql
-- View clearance requests with auto-verification status
SELECT 
    cr.id,
    cr.request_type,
    cr.status,
    cr.vehicle_id,
    v.vin,
    v.plate_number,
    cr.metadata->>'autoVerified' AS auto_verified,
    cr.metadata->'autoVerificationResult'->>'status' AS auto_status,
    cr.metadata->'autoVerificationResult'->>'score' AS auto_score,
    cr.metadata->'autoVerificationResult'->>'confidence' AS auto_confidence,
    cr.metadata->'autoVerificationResult'->>'reason' AS auto_reason,
    cr.created_at,
    cr.updated_at
FROM clearance_requests cr
LEFT JOIN vehicles v ON cr.vehicle_id = v.id
WHERE cr.request_type IN ('insurance', 'emission', 'hpg')
ORDER BY cr.created_at DESC
LIMIT 20;
```

### 5. View Full Auto-Verification Metadata

```sql
-- Detailed auto-verification results
SELECT 
    cr.id AS request_id,
    cr.request_type,
    cr.status,
    v.vin,
    jsonb_pretty(cr.metadata->'autoVerificationResult') AS auto_verification_result,
    jsonb_pretty(cr.metadata->'autoVerify') AS auto_verify_hpg
FROM clearance_requests cr
LEFT JOIN vehicles v ON cr.vehicle_id = v.id
WHERE cr.metadata ? 'autoVerificationResult' 
   OR cr.metadata ? 'autoVerify'
ORDER BY cr.created_at DESC
LIMIT 10;
```

### 6. Check `vehicle_verifications` Table Structure

```bash
docker exec postgres psql -U lto_user -d lto_blockchain -c "\d vehicle_verifications"
```

**Or SQL:**
```sql
SELECT 
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_name = 'vehicle_verifications'
ORDER BY ordinal_position;
```

### 7. View Auto-Verification Status in `vehicle_verifications`

```sql
-- Check auto-verification columns
SELECT 
    vv.id,
    vv.vehicle_id,
    vv.verification_type,
    vv.status,
    vv.automated,
    vv.verification_score,
    vv.auto_verified_at,
    vv.verification_metadata->>'ocrData' AS ocr_data,
    vv.verification_metadata->>'patternCheck' AS pattern_check,
    vv.verification_metadata->>'hashCheck' AS hash_check,
    vv.verification_metadata->>'compositeHash' AS composite_hash,
    vv.verified_at,
    vv.created_at
FROM vehicle_verifications vv
WHERE vv.automated = true
ORDER BY vv.auto_verified_at DESC
LIMIT 20;
```

### 8. Compare Original vs Extracted Data

```sql
-- Compare issued certificate data with verification results
SELECT 
    ic.certificate_type,
    ic.vehicle_vin,
    ic.certificate_number AS original_cert_number,
    ic.metadata->>'engineNumber' AS original_engine,
    ic.metadata->>'chassisNumber' AS original_chassis,
    vv.verification_metadata->'ocrData'->>'insurancePolicyNumber' AS extracted_insurance,
    vv.verification_metadata->'ocrData'->>'certificateNumber' AS extracted_emission,
    vv.verification_metadata->'ocrData'->>'clearanceNumber' AS extracted_hpg,
    vv.verification_metadata->'ocrData'->>'vin' AS extracted_vin,
    vv.verification_metadata->'ocrData'->>'engineNumber' AS extracted_engine,
    vv.verification_metadata->'ocrData'->>'chassisNumber' AS extracted_chassis,
    vv.verification_score,
    vv.status
FROM issued_certificates ic
LEFT JOIN vehicle_verifications vv ON ic.vehicle_vin = (
    SELECT vin FROM vehicles WHERE id = vv.vehicle_id LIMIT 1
)
WHERE ic.certificate_type IN ('insurance', 'emission', 'hpg_clearance')
ORDER BY ic.created_at DESC
LIMIT 10;
```

### 9. Check Hash Matching (Authenticity Check)

```sql
-- Verify file hash matching for authenticity
SELECT 
    ic.certificate_type,
    ic.vehicle_vin,
    ic.certificate_number,
    ic.file_hash AS original_file_hash,
    ic.composite_hash AS original_composite_hash,
    vv.verification_metadata->>'compositeHash' AS verification_composite_hash,
    CASE 
        WHEN ic.file_hash = (vv.verification_metadata->>'fileHash') THEN 'âœ… MATCH'
        ELSE 'âŒ MISMATCH'
    END AS hash_match_status,
    vv.verification_metadata->'authenticityCheck'->>'authentic' AS authenticity_check
FROM issued_certificates ic
LEFT JOIN vehicle_verifications vv ON ic.vehicle_vin = (
    SELECT vin FROM vehicles WHERE id = vv.vehicle_id LIMIT 1
)
WHERE ic.certificate_type IN ('insurance', 'emission', 'hpg_clearance')
ORDER BY ic.created_at DESC
LIMIT 10;
```

### 10. Check Pattern Validation Results

```sql
-- View pattern validation results
SELECT 
    cr.request_type,
    cr.status,
    v.vin,
    cr.metadata->'autoVerificationResult'->'patternCheck'->>'valid' AS pattern_valid,
    cr.metadata->'autoVerificationResult'->'patternCheck'->>'reason' AS pattern_reason,
    cr.metadata->'autoVerificationResult'->'patternCheck'->>'expectedPattern' AS expected_pattern,
    cr.metadata->'autoVerificationResult'->'patternCheck'->>'normalized' AS extracted_number,
    cr.metadata->'autoVerificationResult'->>'score' AS confidence_score
FROM clearance_requests cr
LEFT JOIN vehicles v ON cr.vehicle_id = v.id
WHERE cr.metadata->'autoVerificationResult'->'patternCheck' IS NOT NULL
ORDER BY cr.created_at DESC
LIMIT 20;
```

### 11. Check Duplicate Hash Detection

```sql
-- Find duplicate composite hashes
SELECT 
    composite_hash,
    COUNT(*) AS duplicate_count,
    array_agg(certificate_type) AS certificate_types,
    array_agg(vehicle_vin) AS vehicle_vins,
    array_agg(certificate_number) AS certificate_numbers
FROM issued_certificates
WHERE composite_hash IS NOT NULL
GROUP BY composite_hash
HAVING COUNT(*) > 1
ORDER BY duplicate_count DESC;
```

### 12. Check Auto-Verification Score Distribution

```sql
-- Analyze confidence scores
SELECT 
    request_type,
    CASE 
        WHEN (metadata->'autoVerificationResult'->>'score')::int >= 80 THEN 'High (80-100)'
        WHEN (metadata->'autoVerificationResult'->>'score')::int >= 60 THEN 'Medium (60-79)'
        WHEN (metadata->'autoVerificationResult'->>'score')::int > 0 THEN 'Low (1-59)'
        ELSE 'Zero (0)'
    END AS score_range,
    COUNT(*) AS count,
    AVG((metadata->'autoVerificationResult'->>'score')::int) AS avg_score
FROM clearance_requests
WHERE metadata->'autoVerificationResult'->>'score' IS NOT NULL
GROUP BY request_type, score_range
ORDER BY request_type, score_range;
```

### 13. Check Missing Auto-Verification Columns

```sql
-- Verify auto-verification columns exist in vehicle_verifications
SELECT 
    column_name,
    CASE 
        WHEN column_name IN ('automated', 'verification_score', 'verification_metadata', 'auto_verified_at') 
        THEN 'âœ… EXISTS'
        ELSE 'âš ï¸ OTHER'
    END AS status
FROM information_schema.columns
WHERE table_name = 'vehicle_verifications'
ORDER BY 
    CASE 
        WHEN column_name IN ('automated', 'verification_score', 'verification_metadata', 'auto_verified_at') 
        THEN 0 ELSE 1 
    END,
    column_name;
```

### 14. Check Recent Auto-Verifications

```sql
-- Recent auto-verification activity
SELECT 
    cr.request_type,
    cr.status,
    v.vin,
    v.plate_number,
    cr.metadata->'autoVerificationResult'->>'status' AS auto_status,
    cr.metadata->'autoVerificationResult'->>'score' AS score,
    cr.metadata->'autoVerificationResult'->>'reason' AS reason,
    cr.created_at,
    cr.updated_at
FROM clearance_requests cr
LEFT JOIN vehicles v ON cr.vehicle_id = v.id
WHERE cr.metadata ? 'autoVerificationResult'
   OR cr.metadata ? 'autoVerify'
ORDER BY cr.updated_at DESC
LIMIT 30;
```

### 15. Check OCR Extraction Quality

```sql
-- Analyze OCR extraction success rate
SELECT 
    cr.request_type,
    CASE 
        WHEN cr.metadata->'autoVerificationResult'->'ocrData'->>'insurancePolicyNumber' IS NOT NULL THEN 'Insurance Number Extracted'
        WHEN cr.metadata->'autoVerificationResult'->'ocrData'->>'certificateNumber' IS NOT NULL THEN 'Emission Number Extracted'
        WHEN cr.metadata->'autoVerificationResult'->'ocrData'->>'clearanceNumber' IS NOT NULL THEN 'HPG Number Extracted'
        WHEN cr.metadata->'autoVerificationResult'->'ocrData'->>'vin' IS NOT NULL THEN 'VIN Extracted'
        ELSE 'No Data Extracted'
    END AS extraction_status,
    COUNT(*) AS count,
    AVG((cr.metadata->'autoVerificationResult'->>'score')::int) AS avg_score
FROM clearance_requests cr
WHERE cr.metadata->'autoVerificationResult'->'ocrData' IS NOT NULL
GROUP BY cr.request_type, extraction_status
ORDER BY cr.request_type, count DESC;
```

---

## ðŸ”§ Quick Health Check Script

```bash
# Run all checks at once
docker exec postgres psql -U lto_user -d lto_blockchain << 'EOF'
\echo '=== 1. Issued Certificates Count ==='
SELECT certificate_type, COUNT(*) FROM issued_certificates GROUP BY certificate_type;

\echo '=== 2. Clearance Requests with Auto-Verification ==='
SELECT request_type, COUNT(*) FROM clearance_requests 
WHERE metadata ? 'autoVerificationResult' OR metadata ? 'autoVerify'
GROUP BY request_type;

\echo '=== 3. Auto-Verification Status Distribution ==='
SELECT 
    request_type,
    metadata->'autoVerificationResult'->>'status' AS auto_status,
    COUNT(*) 
FROM clearance_requests 
WHERE metadata->'autoVerificationResult'->>'status' IS NOT NULL
GROUP BY request_type, auto_status;

\echo '=== 4. Vehicle Verifications with Auto-Verification ==='
SELECT verification_type, COUNT(*) FROM vehicle_verifications 
WHERE automated = true GROUP BY verification_type;

\echo '=== 5. Missing Auto-Verification Columns Check ==='
SELECT 
    CASE WHEN EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'vehicle_verifications' AND column_name = 'automated'
    ) THEN 'âœ… automated column exists' ELSE 'âŒ automated column MISSING' END,
    CASE WHEN EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'vehicle_verifications' AND column_name = 'verification_score'
    ) THEN 'âœ… verification_score column exists' ELSE 'âŒ verification_score column MISSING' END,
    CASE WHEN EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'vehicle_verifications' AND column_name = 'verification_metadata'
    ) THEN 'âœ… verification_metadata column exists' ELSE 'âŒ verification_metadata column MISSING' END,
    CASE WHEN EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'vehicle_verifications' AND column_name = 'auto_verified_at'
    ) THEN 'âœ… auto_verified_at column exists' ELSE 'âŒ auto_verified_at column MISSING' END;
EOF
```

---

## ðŸ“‹ Table Schema Verification

### Required Columns Checklist

#### `issued_certificates`
- âœ… `id` (UUID)
- âœ… `certificate_type` (VARCHAR)
- âœ… `vehicle_vin` (VARCHAR)
- âœ… `certificate_number` (VARCHAR)
- âœ… `file_hash` (VARCHAR)
- âœ… `composite_hash` (VARCHAR)
- âœ… `issued_at` (DATE)
- âœ… `expires_at` (DATE)
- âœ… `metadata` (JSONB)

#### `clearance_requests`
- âœ… `id` (UUID)
- âœ… `request_type` (VARCHAR) - 'insurance', 'emission', 'hpg'
- âœ… `status` (VARCHAR)
- âœ… `vehicle_id` (UUID)
- âœ… `metadata` (JSONB) - **Stores auto-verification results**

#### `vehicle_verifications`
- âœ… `id` (UUID)
- âœ… `vehicle_id` (UUID)
- âœ… `verification_type` (VARCHAR)
- âœ… `status` (ENUM)
- âš ï¸ `automated` (BOOLEAN) - **Required for auto-verification**
- âš ï¸ `verification_score` (INTEGER) - **Required for auto-verification**
- âš ï¸ `verification_metadata` (JSONB) - **Required for auto-verification**
- âš ï¸ `auto_verified_at` (TIMESTAMP) - **Required for auto-verification**

---

## ðŸ› Troubleshooting Queries

### Find Failed Auto-Verifications

```sql
SELECT 
    cr.id,
    cr.request_type,
    cr.status,
    v.vin,
    cr.metadata->'autoVerificationResult'->>'reason' AS failure_reason,
    cr.metadata->'autoVerificationResult'->>'score' AS score,
    cr.created_at
FROM clearance_requests cr
LEFT JOIN vehicles v ON cr.vehicle_id = v.id
WHERE cr.metadata->'autoVerificationResult'->>'status' = 'REJECTED'
   OR (cr.metadata->'autoVerificationResult'->>'score')::int < 60
ORDER BY cr.created_at DESC;
```

### Find Missing Original Certificates

```sql
SELECT 
    cr.id,
    cr.request_type,
    v.vin,
    cr.metadata->'autoVerificationResult'->'authenticityCheck'->>'originalCertificateFound' AS original_found,
    cr.metadata->'autoVerificationResult'->'authenticityCheck'->>'reason' AS authenticity_reason
FROM clearance_requests cr
LEFT JOIN vehicles v ON cr.vehicle_id = v.id
WHERE cr.metadata->'autoVerificationResult'->'authenticityCheck'->>'originalCertificateFound' = 'false'
ORDER BY cr.created_at DESC;
```

---

## ðŸ“ Notes

- All queries use PostgreSQL syntax (`jsonb_pretty`, `->`, `->>`)
- For MySQL, replace `jsonb_pretty()` with `JSON_PRETTY()`
- Replace `->` with `JSON_EXTRACT()` and `->>` with `JSON_UNQUOTE(JSON_EXTRACT())`
- UUIDs in PostgreSQL vs CHAR(36) in MySQL
